# 🔧 节点管理指南

本文档介绍如何在已部署的 Kubernetes 集群中进行节点的添加、删除和角色管理操作。

## 📋 操作概览

### 🚀 节点添加操作
- [➕ 添加 Worker 节点](02/添加%20worker%20节点.md) - 扩展集群计算能力
- [🎯 添加 Master 节点](02/添加%20master%20节点.md) - 增强控制平面高可用性  
- [💾 添加 Etcd 节点](02/添加%20etcd%20节点.md) - 扩展数据存储集群

### 🗑️ 节点删除操作
- [❌ 删除节点 Master 角色](02/删除节点%20master%20角色.md) - 移除控制平面角色
- [🚫 删除节点 Worker 角色](02/删除节点%20worker%20角色.md) - 移除工作节点角色
- [🗂️ 删除集群节点](02/删除集群节点.md) - 完全移除节点
- [💿 删除 Etcd 节点](02/删除%20etcd%20节点.md) - 缩减存储集群

### ⚖️ 负载均衡管理
- [🔄 增加或删除 LB 节点](02/增加或删除%20lb%20节点.md) - 管理负载均衡器节点

### 🔄 运行时切换
- [🐳 Docker 切换为 containerd](02/Docker切换为containerd.md) - 容器运行时迁移

## 📖 详细操作指南

### 🎯 节点角色说明

在 Kubernetes 集群中，节点可以承担以下角色：

| 角色类型 | 功能描述 | 推荐数量 | 注意事项 |
|:---------|:---------|:---------|:---------|
| **Master** | 控制平面组件，管理集群状态 | 3个（奇数） | 高可用配置，避免脑裂 |
| **Worker** | 运行应用工作负载 | 按需扩展 | 提供计算资源 |
| **Etcd** | 分布式键值存储 | 3/5/7个（奇数） | 数据持久化，性能关键 |
| **LB** | API Server 负载均衡 | 2个 | 提供高可用入口 |

### 🔄 节点操作流程

#### 添加节点的一般流程

1. **准备阶段**
   - 确保新节点满足系统要求
   - 配置网络连通性
   - 更新主机清单文件

2. **执行阶段**
   - 运行相应的 Ansible Playbook
   - 监控执行过程
   - 验证操作结果

3. **后处理阶段**
   - 更新配置文件
   - 验证集群状态
   - 记录变更信息

#### 删除节点的一般流程

1. **准备阶段**
   - 驱逐节点上的 Pod（如适用）
   - 确认删除不会影响服务可用性
   - 备份重要数据

2. **执行阶段**
   - 运行相应的 Ansible Playbook
   - 监控删除过程

3. **清理阶段**
   - 更新主机清单文件
   - 清理相关配置
   - 验证集群状态

### ⚠️ 操作注意事项

#### 🚨 重要提醒

1. **Master 节点管理**
   - Master 节点数量必须为奇数（1, 3, 5, 7...）
   - 删除 Master 节点时确保剩余节点数量仍为奇数
   - 避免同时操作多个 Master 节点

2. **Etcd 节点管理**
   - Etcd 节点数量必须为奇数
   - 一次只能添加或删除一个 Etcd 节点
   - 操作前建议进行数据备份

3. **Worker 节点管理**
   - 删除前确保工作负载已迁移
   - 建议在业务低峰期进行操作
   - 监控集群资源使用情况

4. **网络配置**
   - 确保新节点网络配置正确
   - 验证防火墙和安全组设置
   - 检查时间同步状态

### 🔍 操作验证

#### 验证命令示例

```bash
# 检查节点状态
kubectl get nodes -o wide

# 检查节点详细信息
kubectl describe node <node-name>

# 检查集群健康状态
kubectl get cs

# 检查 Etcd 集群状态
kubectl -n kube-system exec -it etcd-<master-node> -- etcdctl \
  --endpoints=https://127.0.0.1:2379 \
  --cacert=/etc/kubernetes/pki/etcd/ca.crt \
  --cert=/etc/kubernetes/pki/etcd/server.crt \
  --key=/etc/kubernetes/pki/etcd/server.key \
  member list

# 检查 Pod 分布情况
kubectl get pods -o wide --all-namespaces
```

### 📊 集群监控

#### 关键指标监控

```bash
# 节点资源使用情况
kubectl top nodes

# Pod 资源使用情况
kubectl top pods --all-namespaces

# 查看集群事件
kubectl get events --sort-by=.metadata.creationTimestamp

# 检查系统 Pod 状态
kubectl get pods -n kube-system
```

## 🛠️ 故障排查

### 常见问题及解决方案

#### 1. 节点加入失败

```bash
# 检查网络连通性
ping <target-node-ip>

# 检查时间同步
chrony sources -v

# 检查 kubeadm 日志
journalctl -u kubelet -f
```

#### 2. 节点状态异常

```bash
# 重启 kubelet 服务
systemctl restart kubelet

# 检查容器运行时状态
systemctl status containerd  # 或 docker

# 检查网络插件状态
kubectl get pods -n kube-system | grep -E "(calico|flannel)"
```

#### 3. Etcd 集群问题

```bash
# 检查 Etcd 健康状态
kubectl -n kube-system exec -it etcd-<node> -- etcdctl endpoint health

# 查看 Etcd 成员列表
kubectl -n kube-system exec -it etcd-<node> -- etcdctl member list
```

## 📚 相关文档

- [📋 安装须知](00-安装须知.md) - 了解系统要求
- [🚀 集群安装](01-集群安装.md) - 初始集群部署
- [🔐 证书轮换](03-证书轮换.md) - 证书管理
- [⬆️ 集群升级](04-集群升级.md) - 版本升级
- [💾 集群备份](05-集群备份.md) - 数据备份

## 📞 获取帮助

如果在节点管理过程中遇到问题：

1. 📖 查看对应的详细操作文档
2. 🔍 检查 Ansible 执行日志
3. 📋 确认主机清单配置
4. 🐛 [报告问题](https://github.com/TimeBye/Kubernetes/issues) 获取技术支持

---

**提示**: 建议在生产环境进行节点操作前，先在测试环境验证操作流程，确保操作的安全性和可靠性。