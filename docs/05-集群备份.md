# ğŸ’¾ é›†ç¾¤å¤‡ä»½æŒ‡å—

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»å¦‚ä½•å¯¹ Kubernetes é›†ç¾¤è¿›è¡Œå®Œæ•´å¤‡ä»½ï¼Œç¡®ä¿æ•°æ®å®‰å…¨å’Œä¸šåŠ¡è¿ç»­æ€§ã€‚

## ğŸ“‹ å¤‡ä»½æ¦‚è¿°

### ä»€ä¹ˆæ˜¯é›†ç¾¤å¤‡ä»½ï¼Ÿ

é›†ç¾¤å¤‡ä»½æ˜¯æŒ‡å¯¹ Kubernetes é›†ç¾¤çš„å…³é”®æ•°æ®å’Œé…ç½®è¿›è¡Œå®Œæ•´ä¿å­˜çš„è¿‡ç¨‹ï¼ŒåŒ…æ‹¬ï¼š

- **ğŸ—„ï¸ Etcd æ•°æ®**: é›†ç¾¤çŠ¶æ€å’Œé…ç½®ä¿¡æ¯
- **ğŸ” è¯ä¹¦æ–‡ä»¶**: TLS è¯ä¹¦å’Œå¯†é’¥
- **âš™ï¸ é…ç½®æ–‡ä»¶**: kubelet å’Œå…¶ä»–ç»„ä»¶é…ç½®
- **ğŸ“‹ æ¸…å•æ–‡ä»¶**: åº”ç”¨éƒ¨ç½²æ¸…å•å’Œé…ç½®

### å¤‡ä»½çš„é‡è¦æ€§

- **ğŸ›¡ï¸ ç¾éš¾æ¢å¤**: åœ¨ç¡¬ä»¶æ•…éšœæˆ–äººä¸ºé”™è¯¯æ—¶å¿«é€Ÿæ¢å¤
- **ğŸ“Š æ•°æ®ä¿æŠ¤**: é˜²æ­¢å…³é”®æ•°æ®ä¸¢å¤±
- **ğŸ”„ ç¯å¢ƒè¿ç§»**: æ”¯æŒé›†ç¾¤è¿ç§»å’Œå¤åˆ¶
- **ğŸ§ª æµ‹è¯•ç¯å¢ƒ**: åˆ›å»ºç”Ÿäº§ç¯å¢ƒçš„å®Œæ•´å‰¯æœ¬
- **ğŸ“ˆ ç‰ˆæœ¬å›æ»š**: å‡çº§å¤±è´¥æ—¶çš„å›æ»šæ–¹æ¡ˆ

## ğŸ¯ å¤‡ä»½ç­–ç•¥

### å¤‡ä»½é¢‘ç‡å»ºè®®

| ç¯å¢ƒç±»å‹ | å¤‡ä»½é¢‘ç‡ | ä¿ç•™æœŸé™ | è¯´æ˜ |
|:---------|:---------|:---------|:-----|
| **ç”Ÿäº§ç¯å¢ƒ** | æ¯æ—¥å¤‡ä»½ | 30 å¤© | å…³é”®ä¸šåŠ¡ç³»ç»Ÿ |
| **æµ‹è¯•ç¯å¢ƒ** | æ¯å‘¨å¤‡ä»½ | 14 å¤© | å¼€å‘æµ‹è¯•ä½¿ç”¨ |
| **å¼€å‘ç¯å¢ƒ** | æŒ‰éœ€å¤‡ä»½ | 7 å¤© | å¼€å‘è°ƒè¯•ç¯å¢ƒ |

### å¤‡ä»½å†…å®¹æ¸…å•

âœ… **åŒ…å«çš„å¤‡ä»½å†…å®¹**:
- Etcd æ•°æ®å¿«ç…§
- Kubernetes è¯ä¹¦ (`/etc/kubernetes/pki/`)
- Kubelet é…ç½®æ–‡ä»¶
- è‡ªå®šä¹‰é…ç½®æ–‡ä»¶
- ä¸»æœºæ¸…å•é…ç½®

âŒ **ä¸åŒ…å«çš„å†…å®¹**:
- åº”ç”¨æ•°æ®ï¼ˆéœ€è¦å•ç‹¬å¤‡ä»½ï¼‰
- æŒä¹…å·æ•°æ®ï¼ˆéœ€è¦å­˜å‚¨å±‚å¤‡ä»½ï¼‰
- å®¹å™¨é•œåƒï¼ˆå¯ä»é•œåƒä»“åº“é‡æ–°è·å–ï¼‰

## ğŸ”§ æ‰§è¡Œé›†ç¾¤å¤‡ä»½

### æ–¹æ³•ä¸€ï¼šåŸºæœ¬é…ç½®å¤‡ä»½

é€‚ç”¨äºä½¿ç”¨é»˜è®¤é…ç½®éƒ¨ç½²çš„é›†ç¾¤ï¼š

```bash
# æ‰§è¡Œé›†ç¾¤å¤‡ä»½
ansible-playbook -i example/hosts.m-master.ip.ini 93-backup-cluster.yml
```

### æ–¹æ³•äºŒï¼šé«˜çº§é…ç½®å¤‡ä»½

é€‚ç”¨äºä½¿ç”¨è‡ªå®šä¹‰é…ç½®éƒ¨ç½²çš„é›†ç¾¤ï¼š

```bash
# ä½¿ç”¨è‡ªå®šä¹‰é…ç½®æ‰§è¡Œå¤‡ä»½
ansible-playbook -i example/hosts.m-master.ip.ini -e @example/variables.yaml 93-backup-cluster.yml
```

> **é‡è¦æé†’**: å¦‚æœé›†ç¾¤æ˜¯ä½¿ç”¨é«˜çº§é…ç½®éƒ¨ç½²çš„ï¼Œå¤‡ä»½æ—¶ä¹Ÿå¿…é¡»ä½¿ç”¨ç›¸åŒçš„é…ç½®å‚æ•°ã€‚

### ç›‘æ§å¤‡ä»½è¿‡ç¨‹

```bash
# ç›‘æ§ Ansible æ‰§è¡Œè¿‡ç¨‹
tail -f /tmp/ansible.log

# æ£€æŸ¥ç£ç›˜ä½¿ç”¨æƒ…å†µ
df -h

# ç›‘æ§å¤‡ä»½æ–‡ä»¶ç”Ÿæˆ
watch ls -la cluster-backup/
```

## ğŸ“ å¤‡ä»½æ–‡ä»¶ç»“æ„

### å¤‡ä»½ç›®å½•è¯´æ˜

æ‰§è¡Œå¤‡ä»½åï¼Œä¼šåœ¨ playbook æ‰€åœ¨ç›®å½•ç”Ÿæˆ `cluster-backup` æ–‡ä»¶å¤¹ï¼š

```
cluster-backup/
â”œâ”€â”€ node1-kubernetes.orig.20241201-143022.tar.gz    # èŠ‚ç‚¹1å¤‡ä»½æ–‡ä»¶
â”œâ”€â”€ node2-kubernetes.orig.20241201-143025.tar.gz    # èŠ‚ç‚¹2å¤‡ä»½æ–‡ä»¶
â”œâ”€â”€ node3-kubernetes.orig.20241201-143028.tar.gz    # èŠ‚ç‚¹3å¤‡ä»½æ–‡ä»¶
â”œâ”€â”€ etcd-snapshot-20241201-143030.db                 # Etcdæ•°æ®å¿«ç…§
â”œâ”€â”€ backup-info.txt                                  # å¤‡ä»½ä¿¡æ¯æ–‡ä»¶
â””â”€â”€ README.md                                        # å¤‡ä»½è¯´æ˜æ–‡æ¡£
```

### å¤‡ä»½æ–‡ä»¶å‘½åè§„åˆ™

- **æ ¼å¼**: `<èŠ‚ç‚¹å>-kubernetes.orig.<æ—¶é—´æˆ³>.tar.gz`
- **æ—¶é—´æˆ³**: `YYYYMMDD-HHMMSS` æ ¼å¼
- **ç¤ºä¾‹**: `node1-kubernetes.orig.20241201-143022.tar.gz`

### å¤‡ä»½æ–‡ä»¶å†…å®¹

æ¯ä¸ªèŠ‚ç‚¹çš„å¤‡ä»½æ–‡ä»¶åŒ…å«ï¼š

```bash
# æŸ¥çœ‹å¤‡ä»½æ–‡ä»¶å†…å®¹
tar -tzf cluster-backup/node1-kubernetes.orig.20241201-143022.tar.gz

# å…¸å‹å†…å®¹åŒ…æ‹¬ï¼š
etc/kubernetes/                 # Kubernetes é…ç½®ç›®å½•
â”œâ”€â”€ admin.conf                  # ç®¡ç†å‘˜é…ç½®
â”œâ”€â”€ kubelet.conf                # kubelet é…ç½®
â”œâ”€â”€ controller-manager.conf     # æ§åˆ¶å™¨é…ç½®
â”œâ”€â”€ scheduler.conf              # è°ƒåº¦å™¨é…ç½®
â”œâ”€â”€ pki/                        # è¯ä¹¦ç›®å½•
â”‚   â”œâ”€â”€ ca.crt                  # CA è¯ä¹¦
â”‚   â”œâ”€â”€ ca.key                  # CA ç§é’¥
â”‚   â”œâ”€â”€ apiserver.crt           # API Server è¯ä¹¦
â”‚   â””â”€â”€ ...                     # å…¶ä»–è¯ä¹¦æ–‡ä»¶
â”œâ”€â”€ manifests/                  # é™æ€ Pod æ¸…å•
â””â”€â”€ ...                         # å…¶ä»–é…ç½®æ–‡ä»¶

var/lib/kubelet/                # kubelet æ•°æ®ç›®å½•
â”œâ”€â”€ config.yaml                 # kubelet é…ç½®
â”œâ”€â”€ kubeadm-flags.env          # kubeadm å‚æ•°
â””â”€â”€ ...                         # å…¶ä»– kubelet æ–‡ä»¶
```

## ğŸ” éªŒè¯å¤‡ä»½å®Œæ•´æ€§

### æ£€æŸ¥å¤‡ä»½æ–‡ä»¶

```bash
# è¿›å…¥å¤‡ä»½ç›®å½•
cd cluster-backup/

# æ£€æŸ¥å¤‡ä»½æ–‡ä»¶å¤§å°
ls -lh *.tar.gz

# éªŒè¯å‹ç¼©æ–‡ä»¶å®Œæ•´æ€§
for file in *.tar.gz; do
    echo "æ£€æŸ¥æ–‡ä»¶: $file"
    tar -tzf "$file" > /dev/null && echo "âœ… å®Œæ•´" || echo "âŒ æŸå"
done

# æ£€æŸ¥ Etcd å¿«ç…§
file etcd-snapshot-*.db
```

### å¤‡ä»½ä¿¡æ¯æ£€æŸ¥

```bash
# æŸ¥çœ‹å¤‡ä»½ä¿¡æ¯æ–‡ä»¶
cat backup-info.txt

# å…¸å‹å†…å®¹åŒ…æ‹¬ï¼š
# å¤‡ä»½æ—¶é—´: 2024-12-01 14:30:22
# é›†ç¾¤ç‰ˆæœ¬: v1.30.2
# èŠ‚ç‚¹æ•°é‡: 4
# å¤‡ä»½å¤§å°: 245MB
# å¤‡ä»½çŠ¶æ€: æˆåŠŸ
```

### å¿«é€ŸéªŒè¯è„šæœ¬

```bash
#!/bin/bash
# åˆ›å»ºå¤‡ä»½éªŒè¯è„šæœ¬
cat > verify-backup.sh << 'EOF'
#!/bin/bash

BACKUP_DIR="cluster-backup"
cd "$BACKUP_DIR" || exit 1

echo "ğŸ” éªŒè¯å¤‡ä»½å®Œæ•´æ€§..."

# æ£€æŸ¥å¿…è¦æ–‡ä»¶æ˜¯å¦å­˜åœ¨
if [ ! -f "backup-info.txt" ]; then
    echo "âŒ ç¼ºå°‘å¤‡ä»½ä¿¡æ¯æ–‡ä»¶"
    exit 1
fi

# æ£€æŸ¥ Etcd å¿«ç…§
ETCD_SNAPSHOT=$(ls etcd-snapshot-*.db 2>/dev/null | head -1)
if [ -z "$ETCD_SNAPSHOT" ]; then
    echo "âŒ ç¼ºå°‘ Etcd å¿«ç…§æ–‡ä»¶"
    exit 1
else
    echo "âœ… Etcd å¿«ç…§: $ETCD_SNAPSHOT"
fi

# æ£€æŸ¥èŠ‚ç‚¹å¤‡ä»½æ–‡ä»¶
NODE_COUNT=$(ls *-kubernetes.orig.*.tar.gz 2>/dev/null | wc -l)
if [ "$NODE_COUNT" -eq 0 ]; then
    echo "âŒ æ²¡æœ‰æ‰¾åˆ°èŠ‚ç‚¹å¤‡ä»½æ–‡ä»¶"
    exit 1
else
    echo "âœ… èŠ‚ç‚¹å¤‡ä»½æ–‡ä»¶: $NODE_COUNT ä¸ª"
fi

# éªŒè¯å‹ç¼©æ–‡ä»¶å®Œæ•´æ€§
echo "ğŸ” éªŒè¯å‹ç¼©æ–‡ä»¶å®Œæ•´æ€§..."
for file in *.tar.gz; do
    if tar -tzf "$file" > /dev/null 2>&1; then
        echo "âœ… $file"
    else
        echo "âŒ $file æŸå"
        exit 1
    fi
done

echo "ğŸ‰ å¤‡ä»½éªŒè¯å®Œæˆï¼æ‰€æœ‰æ–‡ä»¶å®Œæ•´ã€‚"
EOF

chmod +x verify-backup.sh
./verify-backup.sh
```

## ğŸ—ƒï¸ å¤‡ä»½ç®¡ç†

### è‡ªåŠ¨åŒ–å¤‡ä»½è„šæœ¬

```bash
#!/bin/bash
# åˆ›å»ºè‡ªåŠ¨åŒ–å¤‡ä»½è„šæœ¬
cat > auto-backup.sh << 'EOF'
#!/bin/bash

set -e

# é…ç½®å˜é‡
BACKUP_RETENTION_DAYS=30
INVENTORY_FILE="example/hosts.m-master.ip.ini"
VARIABLES_FILE="example/variables.yaml"
LOG_FILE="/var/log/k8s-backup.log"

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

log "å¼€å§‹æ‰§è¡Œ Kubernetes é›†ç¾¤å¤‡ä»½..."

# æ‰§è¡Œå¤‡ä»½
if [ -f "$VARIABLES_FILE" ]; then
    log "ä½¿ç”¨é«˜çº§é…ç½®æ‰§è¡Œå¤‡ä»½"
    ansible-playbook -i "$INVENTORY_FILE" -e @"$VARIABLES_FILE" 93-backup-cluster.yml
else
    log "ä½¿ç”¨åŸºæœ¬é…ç½®æ‰§è¡Œå¤‡ä»½"
    ansible-playbook -i "$INVENTORY_FILE" 93-backup-cluster.yml
fi

# æ£€æŸ¥å¤‡ä»½ç»“æœ
if [ $? -eq 0 ]; then
    log "âœ… å¤‡ä»½æ‰§è¡ŒæˆåŠŸ"
else
    log "âŒ å¤‡ä»½æ‰§è¡Œå¤±è´¥"
    exit 1
fi

# æ¸…ç†æ—§å¤‡ä»½
log "æ¸…ç† $BACKUP_RETENTION_DAYS å¤©å‰çš„æ—§å¤‡ä»½..."
find cluster-backup/ -name "*.tar.gz" -type f -mtime +$BACKUP_RETENTION_DAYS -delete
find cluster-backup/ -name "etcd-snapshot-*.db" -type f -mtime +$BACKUP_RETENTION_DAYS -delete

log "å¤‡ä»½ä»»åŠ¡å®Œæˆï¼"
EOF

chmod +x auto-backup.sh
```

### è®¾ç½®å®šæ—¶å¤‡ä»½

```bash
# æ·»åŠ  crontab ä»»åŠ¡ï¼ˆæ¯æ—¥å‡Œæ™¨2ç‚¹æ‰§è¡Œï¼‰
crontab -e

# æ·»åŠ ä»¥ä¸‹è¡Œ
0 2 * * * /path/to/auto-backup.sh >> /var/log/k8s-backup.log 2>&1

# éªŒè¯ crontab è®¾ç½®
crontab -l
```

### å¤‡ä»½å­˜å‚¨å»ºè®®

1. **æœ¬åœ°å­˜å‚¨**
   ```bash
   # å°†å¤‡ä»½ç§»åŠ¨åˆ°å®‰å…¨ä½ç½®
   sudo mkdir -p /backup/kubernetes
   sudo mv cluster-backup/* /backup/kubernetes/
   sudo chown -R root:root /backup/kubernetes
   sudo chmod -R 600 /backup/kubernetes
   ```

2. **è¿œç¨‹å­˜å‚¨**
   ```bash
   # ä¸Šä¼ åˆ°è¿œç¨‹å­˜å‚¨ï¼ˆç¤ºä¾‹ï¼šrsyncï¼‰
   rsync -av cluster-backup/ backup-server:/backup/kubernetes/$(date +%Y%m%d)/
   
   # æˆ–ä½¿ç”¨ rclone ä¸Šä¼ åˆ°äº‘å­˜å‚¨
   rclone copy cluster-backup/ remote:kubernetes-backup/$(date +%Y%m%d)/
   ```

3. **åŠ å¯†å­˜å‚¨**
   ```bash
   # ä½¿ç”¨ GPG åŠ å¯†å¤‡ä»½æ–‡ä»¶
   tar -czf - cluster-backup/ | gpg --cipher-algo AES256 --compress-algo 1 \
       --symmetric --output k8s-backup-$(date +%Y%m%d).tar.gz.gpg
   ```

## âš ï¸ æ³¨æ„äº‹é¡¹

### ğŸš¨ é‡è¦æé†’

1. **ä¸€è‡´æ€§å¤‡ä»½**
   - å»ºè®®åœ¨ä¸šåŠ¡ä½å³°æœŸæ‰§è¡Œå¤‡ä»½
   - ç¡®ä¿å¤‡ä»½è¿‡ç¨‹ä¸­é›†ç¾¤çŠ¶æ€ç¨³å®š

2. **å­˜å‚¨ç©ºé—´**
   - ç›‘æ§å¤‡ä»½æ–‡ä»¶å¤§å°å’Œç£ç›˜ä½¿ç”¨æƒ…å†µ
   - å®šæœŸæ¸…ç†è¿‡æœŸå¤‡ä»½æ–‡ä»¶

3. **ç½‘ç»œç¨³å®šæ€§**
   - ç¡®ä¿ Ansible æ§åˆ¶èŠ‚ç‚¹ä¸æ‰€æœ‰ç›®æ ‡èŠ‚ç‚¹ç½‘ç»œç¨³å®š
   - å¤‡ä»½è¿‡ç¨‹ä¸­é¿å…ç½‘ç»œä¸­æ–­

4. **æƒé™ç®¡ç†**
   - å¤‡ä»½æ–‡ä»¶åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼ˆè¯ä¹¦ã€å¯†é’¥ï¼‰
   - å¦¥å–„ä¿ç®¡å¤‡ä»½æ–‡ä»¶ï¼Œè®¾ç½®é€‚å½“æƒé™

### ğŸ”’ å®‰å…¨å»ºè®®

```bash
# è®¾ç½®å¤‡ä»½ç›®å½•å®‰å…¨æƒé™
chmod 700 cluster-backup/
chmod 600 cluster-backup/*

# åŠ å¯†æ•æ„Ÿå¤‡ä»½æ–‡ä»¶
for file in cluster-backup/*.tar.gz; do
    gpg --symmetric --cipher-algo AES256 "$file"
    rm "$file"  # åˆ é™¤æœªåŠ å¯†ç‰ˆæœ¬
done
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ğŸ”„ é›†ç¾¤æ¢å¤](06-é›†ç¾¤æ¢å¤.md) - ä½¿ç”¨å¤‡ä»½æ¢å¤é›†ç¾¤
- [â¬†ï¸ é›†ç¾¤å‡çº§](04-é›†ç¾¤å‡çº§.md) - å‡çº§å‰çš„å¤‡ä»½å‡†å¤‡
- [ğŸ” è¯ä¹¦è½®æ¢](03-è¯ä¹¦è½®æ¢.md) - è¯ä¹¦ç›¸å…³å¤‡ä»½
- [ğŸš€ é›†ç¾¤å®‰è£…](01-é›†ç¾¤å®‰è£….md) - åˆå§‹é›†ç¾¤é…ç½®

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœåœ¨é›†ç¾¤å¤‡ä»½è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š

1. ğŸ“– æŸ¥çœ‹è¯¦ç»†çš„ Ansible æ‰§è¡Œæ—¥å¿—
2. ğŸ” æ£€æŸ¥ç£ç›˜ç©ºé—´å’Œç½‘ç»œè¿æ¥
3. ğŸ“‹ ç¡®è®¤èŠ‚ç‚¹çŠ¶æ€å’Œæƒé™è®¾ç½®
4. ğŸ› [æŠ¥å‘Šé—®é¢˜](https://github.com/TimeBye/Kubernetes/issues) è·å–æŠ€æœ¯æ”¯æŒ

---

**é‡è¦æç¤º**: 
- ğŸ”„ å®šæœŸæµ‹è¯•å¤‡ä»½æ¢å¤æµç¨‹ï¼Œç¡®ä¿å¤‡ä»½çš„å¯ç”¨æ€§
- ğŸ’¾ å»ºè®®é‡‡ç”¨ 3-2-1 å¤‡ä»½ç­–ç•¥ï¼ˆ3ä»½å¤‡ä»½ï¼Œ2ç§å­˜å‚¨ä»‹è´¨ï¼Œ1ä»½å¼‚åœ°å­˜å‚¨ï¼‰
- ğŸ“… åˆ¶å®šå¤‡ä»½è®¡åˆ’å¹¶ä¸¥æ ¼æ‰§è¡Œ
- ğŸ” å¯¹åŒ…å«æ•æ„Ÿä¿¡æ¯çš„å¤‡ä»½æ–‡ä»¶è¿›è¡ŒåŠ å¯†ä¿æŠ¤