# 💾 集群备份指南

本文档详细介绍如何对 Kubernetes 集群进行完整备份，确保数据安全和业务连续性。

## 📋 备份概述

### 什么是集群备份？

集群备份是指对 Kubernetes 集群的关键数据和配置进行完整保存的过程，包括：

- **🗄️ Etcd 数据**: 集群状态和配置信息
- **🔐 证书文件**: TLS 证书和密钥
- **⚙️ 配置文件**: kubelet 和其他组件配置
- **📋 清单文件**: 应用部署清单和配置

### 备份的重要性

- **🛡️ 灾难恢复**: 在硬件故障或人为错误时快速恢复
- **📊 数据保护**: 防止关键数据丢失
- **🔄 环境迁移**: 支持集群迁移和复制
- **🧪 测试环境**: 创建生产环境的完整副本
- **📈 版本回滚**: 升级失败时的回滚方案

## 🎯 备份策略

### 备份频率建议

| 环境类型 | 备份频率 | 保留期限 | 说明 |
|:---------|:---------|:---------|:-----|
| **生产环境** | 每日备份 | 30 天 | 关键业务系统 |
| **测试环境** | 每周备份 | 14 天 | 开发测试使用 |
| **开发环境** | 按需备份 | 7 天 | 开发调试环境 |

### 备份内容清单

✅ **包含的备份内容**:
- Etcd 数据快照
- Kubernetes 证书 (`/etc/kubernetes/pki/`)
- Kubelet 配置文件
- 自定义配置文件
- 主机清单配置

❌ **不包含的内容**:
- 应用数据（需要单独备份）
- 持久卷数据（需要存储层备份）
- 容器镜像（可从镜像仓库重新获取）

## 🔧 执行集群备份

### 方法一：基本配置备份

适用于使用默认配置部署的集群：

```bash
# 执行集群备份
ansible-playbook -i example/hosts.m-master.ip.ini 93-backup-cluster.yml
```

### 方法二：高级配置备份

适用于使用自定义配置部署的集群：

```bash
# 使用自定义配置执行备份
ansible-playbook -i example/hosts.m-master.ip.ini -e @example/variables.yaml 93-backup-cluster.yml
```

> **重要提醒**: 如果集群是使用高级配置部署的，备份时也必须使用相同的配置参数。

### 监控备份过程

```bash
# 监控 Ansible 执行过程
tail -f /tmp/ansible.log

# 检查磁盘使用情况
df -h

# 监控备份文件生成
watch ls -la cluster-backup/
```

## 📁 备份文件结构

### 备份目录说明

执行备份后，会在 playbook 所在目录生成 `cluster-backup` 文件夹：

```
cluster-backup/
├── node1-kubernetes.orig.20241201-143022.tar.gz    # 节点1备份文件
├── node2-kubernetes.orig.20241201-143025.tar.gz    # 节点2备份文件
├── node3-kubernetes.orig.20241201-143028.tar.gz    # 节点3备份文件
├── etcd-snapshot-20241201-143030.db                 # Etcd数据快照
├── backup-info.txt                                  # 备份信息文件
└── README.md                                        # 备份说明文档
```

### 备份文件命名规则

- **格式**: `<节点名>-kubernetes.orig.<时间戳>.tar.gz`
- **时间戳**: `YYYYMMDD-HHMMSS` 格式
- **示例**: `node1-kubernetes.orig.20241201-143022.tar.gz`

### 备份文件内容

每个节点的备份文件包含：

```bash
# 查看备份文件内容
tar -tzf cluster-backup/node1-kubernetes.orig.20241201-143022.tar.gz

# 典型内容包括：
etc/kubernetes/                 # Kubernetes 配置目录
├── admin.conf                  # 管理员配置
├── kubelet.conf                # kubelet 配置
├── controller-manager.conf     # 控制器配置
├── scheduler.conf              # 调度器配置
├── pki/                        # 证书目录
│   ├── ca.crt                  # CA 证书
│   ├── ca.key                  # CA 私钥
│   ├── apiserver.crt           # API Server 证书
│   └── ...                     # 其他证书文件
├── manifests/                  # 静态 Pod 清单
└── ...                         # 其他配置文件

var/lib/kubelet/                # kubelet 数据目录
├── config.yaml                 # kubelet 配置
├── kubeadm-flags.env          # kubeadm 参数
└── ...                         # 其他 kubelet 文件
```

## 🔍 验证备份完整性

### 检查备份文件

```bash
# 进入备份目录
cd cluster-backup/

# 检查备份文件大小
ls -lh *.tar.gz

# 验证压缩文件完整性
for file in *.tar.gz; do
    echo "检查文件: $file"
    tar -tzf "$file" > /dev/null && echo "✅ 完整" || echo "❌ 损坏"
done

# 检查 Etcd 快照
file etcd-snapshot-*.db
```

### 备份信息检查

```bash
# 查看备份信息文件
cat backup-info.txt

# 典型内容包括：
# 备份时间: 2024-12-01 14:30:22
# 集群版本: v1.30.2
# 节点数量: 4
# 备份大小: 245MB
# 备份状态: 成功
```

### 快速验证脚本

```bash
#!/bin/bash
# 创建备份验证脚本
cat > verify-backup.sh << 'EOF'
#!/bin/bash

BACKUP_DIR="cluster-backup"
cd "$BACKUP_DIR" || exit 1

echo "🔍 验证备份完整性..."

# 检查必要文件是否存在
if [ ! -f "backup-info.txt" ]; then
    echo "❌ 缺少备份信息文件"
    exit 1
fi

# 检查 Etcd 快照
ETCD_SNAPSHOT=$(ls etcd-snapshot-*.db 2>/dev/null | head -1)
if [ -z "$ETCD_SNAPSHOT" ]; then
    echo "❌ 缺少 Etcd 快照文件"
    exit 1
else
    echo "✅ Etcd 快照: $ETCD_SNAPSHOT"
fi

# 检查节点备份文件
NODE_COUNT=$(ls *-kubernetes.orig.*.tar.gz 2>/dev/null | wc -l)
if [ "$NODE_COUNT" -eq 0 ]; then
    echo "❌ 没有找到节点备份文件"
    exit 1
else
    echo "✅ 节点备份文件: $NODE_COUNT 个"
fi

# 验证压缩文件完整性
echo "🔍 验证压缩文件完整性..."
for file in *.tar.gz; do
    if tar -tzf "$file" > /dev/null 2>&1; then
        echo "✅ $file"
    else
        echo "❌ $file 损坏"
        exit 1
    fi
done

echo "🎉 备份验证完成！所有文件完整。"
EOF

chmod +x verify-backup.sh
./verify-backup.sh
```

## 🗃️ 备份管理

### 自动化备份脚本

```bash
#!/bin/bash
# 创建自动化备份脚本
cat > auto-backup.sh << 'EOF'
#!/bin/bash

set -e

# 配置变量
BACKUP_RETENTION_DAYS=30
INVENTORY_FILE="example/hosts.m-master.ip.ini"
VARIABLES_FILE="example/variables.yaml"
LOG_FILE="/var/log/k8s-backup.log"

# 日志函数
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

log "开始执行 Kubernetes 集群备份..."

# 执行备份
if [ -f "$VARIABLES_FILE" ]; then
    log "使用高级配置执行备份"
    ansible-playbook -i "$INVENTORY_FILE" -e @"$VARIABLES_FILE" 93-backup-cluster.yml
else
    log "使用基本配置执行备份"
    ansible-playbook -i "$INVENTORY_FILE" 93-backup-cluster.yml
fi

# 检查备份结果
if [ $? -eq 0 ]; then
    log "✅ 备份执行成功"
else
    log "❌ 备份执行失败"
    exit 1
fi

# 清理旧备份
log "清理 $BACKUP_RETENTION_DAYS 天前的旧备份..."
find cluster-backup/ -name "*.tar.gz" -type f -mtime +$BACKUP_RETENTION_DAYS -delete
find cluster-backup/ -name "etcd-snapshot-*.db" -type f -mtime +$BACKUP_RETENTION_DAYS -delete

log "备份任务完成！"
EOF

chmod +x auto-backup.sh
```

### 设置定时备份

```bash
# 添加 crontab 任务（每日凌晨2点执行）
crontab -e

# 添加以下行
0 2 * * * /path/to/auto-backup.sh >> /var/log/k8s-backup.log 2>&1

# 验证 crontab 设置
crontab -l
```

### 备份存储建议

1. **本地存储**
   ```bash
   # 将备份移动到安全位置
   sudo mkdir -p /backup/kubernetes
   sudo mv cluster-backup/* /backup/kubernetes/
   sudo chown -R root:root /backup/kubernetes
   sudo chmod -R 600 /backup/kubernetes
   ```

2. **远程存储**
   ```bash
   # 上传到远程存储（示例：rsync）
   rsync -av cluster-backup/ backup-server:/backup/kubernetes/$(date +%Y%m%d)/
   
   # 或使用 rclone 上传到云存储
   rclone copy cluster-backup/ remote:kubernetes-backup/$(date +%Y%m%d)/
   ```

3. **加密存储**
   ```bash
   # 使用 GPG 加密备份文件
   tar -czf - cluster-backup/ | gpg --cipher-algo AES256 --compress-algo 1 \
       --symmetric --output k8s-backup-$(date +%Y%m%d).tar.gz.gpg
   ```

## ⚠️ 注意事项

### 🚨 重要提醒

1. **一致性备份**
   - 建议在业务低峰期执行备份
   - 确保备份过程中集群状态稳定

2. **存储空间**
   - 监控备份文件大小和磁盘使用情况
   - 定期清理过期备份文件

3. **网络稳定性**
   - 确保 Ansible 控制节点与所有目标节点网络稳定
   - 备份过程中避免网络中断

4. **权限管理**
   - 备份文件包含敏感信息（证书、密钥）
   - 妥善保管备份文件，设置适当权限

### 🔒 安全建议

```bash
# 设置备份目录安全权限
chmod 700 cluster-backup/
chmod 600 cluster-backup/*

# 加密敏感备份文件
for file in cluster-backup/*.tar.gz; do
    gpg --symmetric --cipher-algo AES256 "$file"
    rm "$file"  # 删除未加密版本
done
```

## 📚 相关文档

- [🔄 集群恢复](06-集群恢复.md) - 使用备份恢复集群
- [⬆️ 集群升级](04-集群升级.md) - 升级前的备份准备
- [🔐 证书轮换](03-证书轮换.md) - 证书相关备份
- [🚀 集群安装](01-集群安装.md) - 初始集群配置

## 📞 获取帮助

如果在集群备份过程中遇到问题：

1. 📖 查看详细的 Ansible 执行日志
2. 🔍 检查磁盘空间和网络连接
3. 📋 确认节点状态和权限设置
4. 🐛 [报告问题](https://github.com/TimeBye/Kubernetes/issues) 获取技术支持

---

**重要提示**: 
- 🔄 定期测试备份恢复流程，确保备份的可用性
- 💾 建议采用 3-2-1 备份策略（3份备份，2种存储介质，1份异地存储）
- 📅 制定备份计划并严格执行
- 🔐 对包含敏感信息的备份文件进行加密保护