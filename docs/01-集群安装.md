# 🚀 集群安装指南

本文档将指导您完成 Kubernetes 高可用集群的安装部署。

## 📋 节点信息示例

以下是一个典型的高可用集群节点配置示例：

| **IP 地址**    | **主机名** | **操作系统** | **内核版本**  | **节点角色**         |
|:-------------:|:----------:|:------------:|:-------------:|:-------------------:|
| 192.168.56.11 | node1      | CentOS 7.8   | 4.20.13-1     | master etcd worker  |
| 192.168.56.12 | node2      | CentOS 7.8   | 4.20.13-1     | master etcd worker  |
| 192.168.56.13 | node3      | CentOS 7.8   | 4.20.13-1     | master etcd worker  |
| 192.168.56.14 | node4      | CentOS 7.8   | 4.20.13-1     | worker              |

## 🔧 环境准备

### 1. 安装 Ansible 运行环境

在任意一台可以访问所有节点的机器上安装 Ansible：

```bash
# 执行安装脚本
sudo ansible/install.sh
```

### 2. 验证 Ansible 连接

```bash
# 测试连接
ansible -i example/hosts.m-master.ip.ini all -m ping
```

## 📝 集群规划

### 主机清单配置

参考 `example` 文件夹下的主机清单文件（ansible inventory），修改各机器的访问地址、用户名、密码，并维护好各节点与角色的关系。

> **重要提示**: 配置的用户必须具有 **root** 权限。生产环境建议一个节点只承担一个角色。

### 节点显示样式选择

部署完成后，集群节点有以下两种显示"样式"：

#### 样式一：IP 地址显示
```bash
kubectl get nodes
NAME            STATUS   ROLES                              AGE     VERSION
192.168.56.11   Ready    control-plane,etcd,master,worker   7m25s   v1.30.2
192.168.56.12   Ready    control-plane,etcd,master,worker   5m18s   v1.30.2
192.168.56.13   Ready    control-plane,etcd,master,worker   5m18s   v1.30.2
192.168.56.14   Ready    worker                             4m37s   v1.30.2
```

#### 样式二：主机名显示
```bash
kubectl get nodes
NAME    STATUS   ROLES                              AGE     VERSION
node1   Ready    control-plane,etcd,master,worker   7m25s   v1.30.2
node2   Ready    control-plane,etcd,master,worker   5m18s   v1.30.2
node3   Ready    control-plane,etcd,master,worker   5m18s   v1.30.2
node4   Ready    worker                             4m37s   v1.30.2
```

### 配置文件示例

| 节点分配     | 样式一配置文件                                                           | 样式二配置文件                                                                     |
|:-------------|:-----------------------------------------------------------------------|:----------------------------------------------------------------------------------|
| 单节点       | [hosts.allinone.ip.ini](../example/hosts.allinone.ip.ini)             | [hosts.allinone.hostname.ini](../example/hosts.allinone.hostname.ini)           |
| 单主多节点   | [hosts.s-master.ip.ini](../example/hosts.s-master.ip.ini)             | [hosts.s-master.hostname.ini](../example/hosts.s-master.hostname.ini)           |
| 多主多节点   | [hosts.m-master.ip.ini](../example/hosts.m-master.ip.ini)             | [hosts.m-master.hostname.ini](../example/hosts.m-master.hostname.ini)           |

## 🚀 集群部署

### 步骤 1: 内核升级（可选）

> **注意**: 默认安装不会升级内核。如需升级内核，请先在一台主机上测试，确认升级后系统能正常启动。

```bash
# 升级内核（升级完成后需要手动重启所有节点）
ansible-playbook -i example/hosts.m-master.ip.ini 00-kernel.yml
```

### 步骤 2: 一键部署集群

#### 基本配置部署

```bash
# 使用默认配置快速部署
ansible-playbook -i example/hosts.m-master.ip.ini 90-init-cluster.yml
```

#### 高级配置部署

```bash
# 使用自定义配置部署
ansible-playbook -i example/hosts.m-master.ip.ini -e @example/variables.yaml 90-init-cluster.yml
```

> **重要说明**:
> 1. 本项目所有可配置项都在 `example/variables.yaml` 文件中，需要自定义配置时删除配置项前的注释符即可。
> 2. 如果使用高级配置部署，以后所有操作都需要添加 `-e @example/variables.yaml` 参数。
> 3. 当 `example/hosts.m-master.ip.ini` 与 `example/variables.yaml` 变量冲突时，`example/variables.yaml` 中的变量值优先级最高。

### 步骤 3: 验证部署结果

```bash
# 检查集群状态
kubectl get nodes

# 检查所有 Pod 状态
kubectl get pods --all-namespaces

# 检查集群信息
kubectl cluster-info
```

## 🐧 特殊系统部署

### Kylin Server 部署

对于麒麟服务器系统，需要特殊的软件源配置：

1. **修改变量文件** `example/variables.yaml`：

```yaml
# 麒麟系统专用软件源配置
base_yum_repo: https://update.cs2c.com.cn/NS/V10/V10SP2/os/adv/lic/base/$basearch/
epel_yum_repo: https://mirrors.tuna.tsinghua.edu.cn/epel/8/Everything/$basearch
docker_yum_repo: https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/centos/8/$basearch/stable
```

2. **执行部署**：

```bash
ansible-playbook -i example/hosts.s-master.ip.ini -e @example/variables.yaml 90-init-cluster.yml
```

## 🔍 部署过程监控

### 查看部署进度

```bash
# 在另一个终端监控部署日志
tail -f /tmp/ansible.log

# 监控特定节点状态
watch kubectl get nodes
```

### 常见部署阶段

1. **环境检查**: 验证系统要求和网络连通性
2. **基础环境**: 安装必要软件包和系统配置
3. **容器运行时**: 安装和配置 Docker 或 containerd
4. **Kubernetes 组件**: 安装 kubeadm、kubelet、kubectl
5. **时间同步**: 配置 NTP 服务
6. **负载均衡**: 部署 API Server 负载均衡器
7. **Etcd 集群**: 部署分布式存储
8. **证书管理**: 生成和分发 TLS 证书
9. **Master 节点**: 初始化控制平面
10. **Worker 节点**: 加入工作节点
11. **网络插件**: 部署 CNI 网络
12. **扩展组件**: 安装 Ingress、监控等组件

## 🔧 故障排查

### 常见问题及解决方案

1. **网络连通性问题**
   ```bash
   # 检查节点间网络
   ansible -i example/hosts.m-master.ip.ini all -m ping
   ```

2. **时间同步问题**
   ```bash
   # 检查时间同步
   ansible -i example/hosts.m-master.ip.ini all -m command -a "date"
   ```

3. **镜像拉取失败**
   ```bash
   # 检查镜像仓库连接
   ansible -i example/hosts.m-master.ip.ini all -m command -a "docker pull k8s.gcr.io/pause:3.9"
   ```

4. **证书问题**
   ```bash
   # 检查证书有效性
   ansible -i example/hosts.m-master.ip.ini kube-master -m command -a "kubeadm certs check-expiration"
   ```

## 📞 获取帮助

- 📖 查看 [安装须知](00-安装须知.md) 了解系统要求
- 🔧 查看 [节点管理](02-节点管理.md) 了解集群管理
- 💾 查看 [离线安装](08-离线安装.md) 了解离线部署
- 🐛 [报告问题](https://github.com/TimeBye/Kubernetes/issues) 获取技术支持

---

**恭喜！** 🎉 您已成功部署了 Kubernetes 高可用集群。接下来可以开始部署您的应用了！