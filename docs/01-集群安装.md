# ğŸš€ é›†ç¾¤å®‰è£…æŒ‡å—

æœ¬æ–‡æ¡£å°†æŒ‡å¯¼æ‚¨å®Œæˆ Kubernetes é«˜å¯ç”¨é›†ç¾¤çš„å®‰è£…éƒ¨ç½²ã€‚

## ğŸ“‹ èŠ‚ç‚¹ä¿¡æ¯ç¤ºä¾‹

ä»¥ä¸‹æ˜¯ä¸€ä¸ªå…¸å‹çš„é«˜å¯ç”¨é›†ç¾¤èŠ‚ç‚¹é…ç½®ç¤ºä¾‹ï¼š

| **IP åœ°å€**    | **ä¸»æœºå** | **æ“ä½œç³»ç»Ÿ** | **å†…æ ¸ç‰ˆæœ¬**  | **èŠ‚ç‚¹è§’è‰²**         |
|:-------------:|:----------:|:------------:|:-------------:|:-------------------:|
| 192.168.56.11 | node1      | CentOS 7.8   | 4.20.13-1     | master etcd worker  |
| 192.168.56.12 | node2      | CentOS 7.8   | 4.20.13-1     | master etcd worker  |
| 192.168.56.13 | node3      | CentOS 7.8   | 4.20.13-1     | master etcd worker  |
| 192.168.56.14 | node4      | CentOS 7.8   | 4.20.13-1     | worker              |

## ğŸ”§ ç¯å¢ƒå‡†å¤‡

### 1. å®‰è£… Ansible è¿è¡Œç¯å¢ƒ

åœ¨ä»»æ„ä¸€å°å¯ä»¥è®¿é—®æ‰€æœ‰èŠ‚ç‚¹çš„æœºå™¨ä¸Šå®‰è£… Ansibleï¼š

```bash
# æ‰§è¡Œå®‰è£…è„šæœ¬
sudo ansible/install.sh
```

### 2. éªŒè¯ Ansible è¿æ¥

```bash
# æµ‹è¯•è¿æ¥
ansible -i example/hosts.m-master.ip.ini all -m ping
```

## ğŸ“ é›†ç¾¤è§„åˆ’

### ä¸»æœºæ¸…å•é…ç½®

å‚è€ƒ `example` æ–‡ä»¶å¤¹ä¸‹çš„ä¸»æœºæ¸…å•æ–‡ä»¶ï¼ˆansible inventoryï¼‰ï¼Œä¿®æ”¹å„æœºå™¨çš„è®¿é—®åœ°å€ã€ç”¨æˆ·åã€å¯†ç ï¼Œå¹¶ç»´æŠ¤å¥½å„èŠ‚ç‚¹ä¸è§’è‰²çš„å…³ç³»ã€‚

> **é‡è¦æç¤º**: é…ç½®çš„ç”¨æˆ·å¿…é¡»å…·æœ‰ **root** æƒé™ã€‚ç”Ÿäº§ç¯å¢ƒå»ºè®®ä¸€ä¸ªèŠ‚ç‚¹åªæ‰¿æ‹…ä¸€ä¸ªè§’è‰²ã€‚

### èŠ‚ç‚¹æ˜¾ç¤ºæ ·å¼é€‰æ‹©

éƒ¨ç½²å®Œæˆåï¼Œé›†ç¾¤èŠ‚ç‚¹æœ‰ä»¥ä¸‹ä¸¤ç§æ˜¾ç¤º"æ ·å¼"ï¼š

#### æ ·å¼ä¸€ï¼šIP åœ°å€æ˜¾ç¤º
```bash
kubectl get nodes
NAME            STATUS   ROLES                              AGE     VERSION
192.168.56.11   Ready    control-plane,etcd,master,worker   7m25s   v1.30.2
192.168.56.12   Ready    control-plane,etcd,master,worker   5m18s   v1.30.2
192.168.56.13   Ready    control-plane,etcd,master,worker   5m18s   v1.30.2
192.168.56.14   Ready    worker                             4m37s   v1.30.2
```

#### æ ·å¼äºŒï¼šä¸»æœºåæ˜¾ç¤º
```bash
kubectl get nodes
NAME    STATUS   ROLES                              AGE     VERSION
node1   Ready    control-plane,etcd,master,worker   7m25s   v1.30.2
node2   Ready    control-plane,etcd,master,worker   5m18s   v1.30.2
node3   Ready    control-plane,etcd,master,worker   5m18s   v1.30.2
node4   Ready    worker                             4m37s   v1.30.2
```

### é…ç½®æ–‡ä»¶ç¤ºä¾‹

| èŠ‚ç‚¹åˆ†é…     | æ ·å¼ä¸€é…ç½®æ–‡ä»¶                                                           | æ ·å¼äºŒé…ç½®æ–‡ä»¶                                                                     |
|:-------------|:-----------------------------------------------------------------------|:----------------------------------------------------------------------------------|
| å•èŠ‚ç‚¹       | [hosts.allinone.ip.ini](../example/hosts.allinone.ip.ini)             | [hosts.allinone.hostname.ini](../example/hosts.allinone.hostname.ini)           |
| å•ä¸»å¤šèŠ‚ç‚¹   | [hosts.s-master.ip.ini](../example/hosts.s-master.ip.ini)             | [hosts.s-master.hostname.ini](../example/hosts.s-master.hostname.ini)           |
| å¤šä¸»å¤šèŠ‚ç‚¹   | [hosts.m-master.ip.ini](../example/hosts.m-master.ip.ini)             | [hosts.m-master.hostname.ini](../example/hosts.m-master.hostname.ini)           |

## ğŸš€ é›†ç¾¤éƒ¨ç½²

### æ­¥éª¤ 1: å†…æ ¸å‡çº§ï¼ˆå¯é€‰ï¼‰

> **æ³¨æ„**: é»˜è®¤å®‰è£…ä¸ä¼šå‡çº§å†…æ ¸ã€‚å¦‚éœ€å‡çº§å†…æ ¸ï¼Œè¯·å…ˆåœ¨ä¸€å°ä¸»æœºä¸Šæµ‹è¯•ï¼Œç¡®è®¤å‡çº§åç³»ç»Ÿèƒ½æ­£å¸¸å¯åŠ¨ã€‚

```bash
# å‡çº§å†…æ ¸ï¼ˆå‡çº§å®Œæˆåéœ€è¦æ‰‹åŠ¨é‡å¯æ‰€æœ‰èŠ‚ç‚¹ï¼‰
ansible-playbook -i example/hosts.m-master.ip.ini 00-kernel.yml
```

### æ­¥éª¤ 2: ä¸€é”®éƒ¨ç½²é›†ç¾¤

#### åŸºæœ¬é…ç½®éƒ¨ç½²

```bash
# ä½¿ç”¨é»˜è®¤é…ç½®å¿«é€Ÿéƒ¨ç½²
ansible-playbook -i example/hosts.m-master.ip.ini 90-init-cluster.yml
```

#### é«˜çº§é…ç½®éƒ¨ç½²

```bash
# ä½¿ç”¨è‡ªå®šä¹‰é…ç½®éƒ¨ç½²
ansible-playbook -i example/hosts.m-master.ip.ini -e @example/variables.yaml 90-init-cluster.yml
```

> **é‡è¦è¯´æ˜**:
> 1. æœ¬é¡¹ç›®æ‰€æœ‰å¯é…ç½®é¡¹éƒ½åœ¨ `example/variables.yaml` æ–‡ä»¶ä¸­ï¼Œéœ€è¦è‡ªå®šä¹‰é…ç½®æ—¶åˆ é™¤é…ç½®é¡¹å‰çš„æ³¨é‡Šç¬¦å³å¯ã€‚
> 2. å¦‚æœä½¿ç”¨é«˜çº§é…ç½®éƒ¨ç½²ï¼Œä»¥åæ‰€æœ‰æ“ä½œéƒ½éœ€è¦æ·»åŠ  `-e @example/variables.yaml` å‚æ•°ã€‚
> 3. å½“ `example/hosts.m-master.ip.ini` ä¸ `example/variables.yaml` å˜é‡å†²çªæ—¶ï¼Œ`example/variables.yaml` ä¸­çš„å˜é‡å€¼ä¼˜å…ˆçº§æœ€é«˜ã€‚

### æ­¥éª¤ 3: éªŒè¯éƒ¨ç½²ç»“æœ

```bash
# æ£€æŸ¥é›†ç¾¤çŠ¶æ€
kubectl get nodes

# æ£€æŸ¥æ‰€æœ‰ Pod çŠ¶æ€
kubectl get pods --all-namespaces

# æ£€æŸ¥é›†ç¾¤ä¿¡æ¯
kubectl cluster-info
```

## ğŸ§ ç‰¹æ®Šç³»ç»Ÿéƒ¨ç½²

### Kylin Server éƒ¨ç½²

å¯¹äºéº’éºŸæœåŠ¡å™¨ç³»ç»Ÿï¼Œéœ€è¦ç‰¹æ®Šçš„è½¯ä»¶æºé…ç½®ï¼š

1. **ä¿®æ”¹å˜é‡æ–‡ä»¶** `example/variables.yaml`ï¼š

```yaml
# éº’éºŸç³»ç»Ÿä¸“ç”¨è½¯ä»¶æºé…ç½®
base_yum_repo: https://update.cs2c.com.cn/NS/V10/V10SP2/os/adv/lic/base/$basearch/
epel_yum_repo: https://mirrors.tuna.tsinghua.edu.cn/epel/8/Everything/$basearch
docker_yum_repo: https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/centos/8/$basearch/stable
```

2. **æ‰§è¡Œéƒ¨ç½²**ï¼š

```bash
ansible-playbook -i example/hosts.s-master.ip.ini -e @example/variables.yaml 90-init-cluster.yml
```

## ğŸ” éƒ¨ç½²è¿‡ç¨‹ç›‘æ§

### æŸ¥çœ‹éƒ¨ç½²è¿›åº¦

```bash
# åœ¨å¦ä¸€ä¸ªç»ˆç«¯ç›‘æ§éƒ¨ç½²æ—¥å¿—
tail -f /tmp/ansible.log

# ç›‘æ§ç‰¹å®šèŠ‚ç‚¹çŠ¶æ€
watch kubectl get nodes
```

### å¸¸è§éƒ¨ç½²é˜¶æ®µ

1. **ç¯å¢ƒæ£€æŸ¥**: éªŒè¯ç³»ç»Ÿè¦æ±‚å’Œç½‘ç»œè¿é€šæ€§
2. **åŸºç¡€ç¯å¢ƒ**: å®‰è£…å¿…è¦è½¯ä»¶åŒ…å’Œç³»ç»Ÿé…ç½®
3. **å®¹å™¨è¿è¡Œæ—¶**: å®‰è£…å’Œé…ç½® Docker æˆ– containerd
4. **Kubernetes ç»„ä»¶**: å®‰è£… kubeadmã€kubeletã€kubectl
5. **æ—¶é—´åŒæ­¥**: é…ç½® NTP æœåŠ¡
6. **è´Ÿè½½å‡è¡¡**: éƒ¨ç½² API Server è´Ÿè½½å‡è¡¡å™¨
7. **Etcd é›†ç¾¤**: éƒ¨ç½²åˆ†å¸ƒå¼å­˜å‚¨
8. **è¯ä¹¦ç®¡ç†**: ç”Ÿæˆå’Œåˆ†å‘ TLS è¯ä¹¦
9. **Master èŠ‚ç‚¹**: åˆå§‹åŒ–æ§åˆ¶å¹³é¢
10. **Worker èŠ‚ç‚¹**: åŠ å…¥å·¥ä½œèŠ‚ç‚¹
11. **ç½‘ç»œæ’ä»¶**: éƒ¨ç½² CNI ç½‘ç»œ
12. **æ‰©å±•ç»„ä»¶**: å®‰è£… Ingressã€ç›‘æ§ç­‰ç»„ä»¶

## ğŸ”§ æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

1. **ç½‘ç»œè¿é€šæ€§é—®é¢˜**
   ```bash
   # æ£€æŸ¥èŠ‚ç‚¹é—´ç½‘ç»œ
   ansible -i example/hosts.m-master.ip.ini all -m ping
   ```

2. **æ—¶é—´åŒæ­¥é—®é¢˜**
   ```bash
   # æ£€æŸ¥æ—¶é—´åŒæ­¥
   ansible -i example/hosts.m-master.ip.ini all -m command -a "date"
   ```

3. **é•œåƒæ‹‰å–å¤±è´¥**
   ```bash
   # æ£€æŸ¥é•œåƒä»“åº“è¿æ¥
   ansible -i example/hosts.m-master.ip.ini all -m command -a "docker pull k8s.gcr.io/pause:3.9"
   ```

4. **è¯ä¹¦é—®é¢˜**
   ```bash
   # æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæ€§
   ansible -i example/hosts.m-master.ip.ini kube-master -m command -a "kubeadm certs check-expiration"
   ```

## ğŸ“ è·å–å¸®åŠ©

- ğŸ“– æŸ¥çœ‹ [å®‰è£…é¡»çŸ¥](00-å®‰è£…é¡»çŸ¥.md) äº†è§£ç³»ç»Ÿè¦æ±‚
- ğŸ”§ æŸ¥çœ‹ [èŠ‚ç‚¹ç®¡ç†](02-èŠ‚ç‚¹ç®¡ç†.md) äº†è§£é›†ç¾¤ç®¡ç†
- ğŸ’¾ æŸ¥çœ‹ [ç¦»çº¿å®‰è£…](08-ç¦»çº¿å®‰è£….md) äº†è§£ç¦»çº¿éƒ¨ç½²
- ğŸ› [æŠ¥å‘Šé—®é¢˜](https://github.com/TimeBye/Kubernetes/issues) è·å–æŠ€æœ¯æ”¯æŒ

---

**æ­å–œï¼** ğŸ‰ æ‚¨å·²æˆåŠŸéƒ¨ç½²äº† Kubernetes é«˜å¯ç”¨é›†ç¾¤ã€‚æ¥ä¸‹æ¥å¯ä»¥å¼€å§‹éƒ¨ç½²æ‚¨çš„åº”ç”¨äº†ï¼