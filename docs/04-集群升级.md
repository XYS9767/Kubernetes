# â¬†ï¸ é›†ç¾¤å‡çº§æŒ‡å—

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»å¦‚ä½•å®‰å…¨åœ°å‡çº§ Kubernetes é›†ç¾¤ç‰ˆæœ¬ï¼Œç¡®ä¿ä¸šåŠ¡è¿ç»­æ€§å’Œæ•°æ®å®‰å…¨ã€‚

## ğŸ“‹ å‡çº§æ¦‚è¿°

### ä»€ä¹ˆæ˜¯é›†ç¾¤å‡çº§ï¼Ÿ

é›†ç¾¤å‡çº§æ˜¯æŒ‡å°† Kubernetes é›†ç¾¤ä»å½“å‰ç‰ˆæœ¬å‡çº§åˆ°æ›´é«˜ç‰ˆæœ¬çš„è¿‡ç¨‹ï¼ŒåŒ…æ‹¬å‡çº§æ§åˆ¶å¹³é¢ç»„ä»¶ã€å·¥ä½œèŠ‚ç‚¹ç»„ä»¶ä»¥åŠç›¸å…³å·¥å…·ã€‚

### å‡çº§çš„å¿…è¦æ€§

- **ğŸ”’ å®‰å…¨æ›´æ–°**: è·å–æœ€æ–°çš„å®‰å…¨ä¿®å¤å’Œè¡¥ä¸
- **ğŸš€ æ–°åŠŸèƒ½**: ä½¿ç”¨æœ€æ–°çš„ Kubernetes ç‰¹æ€§å’ŒåŠŸèƒ½
- **ğŸ› ï¸ Bug ä¿®å¤**: è§£å†³å·²çŸ¥é—®é¢˜å’Œæå‡ç¨³å®šæ€§
- **ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–**: è·å¾—æ€§èƒ½æ”¹è¿›å’Œä¼˜åŒ–
- **ğŸ”„ ç¤¾åŒºæ”¯æŒ**: ä¿æŒåœ¨ç¤¾åŒºæ”¯æŒçš„ç‰ˆæœ¬èŒƒå›´å†…

## ğŸ“š ç‰ˆæœ¬ç®¡ç†åŸºç¡€

### è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶

Kubernetes ä½¿ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶ï¼Œç‰ˆæœ¬æ ¼å¼ä¸ºï¼š`ä¸»ç‰ˆæœ¬å·.æ¬¡ç‰ˆæœ¬å·.ä¿®è®¢å·`

- **ä¸»ç‰ˆæœ¬å·**: ä¸å…¼å®¹çš„ API ä¿®æ”¹
- **æ¬¡ç‰ˆæœ¬å·**: å‘ä¸‹å…¼å®¹çš„åŠŸèƒ½æ€§æ–°å¢
- **ä¿®è®¢å·**: å‘ä¸‹å…¼å®¹çš„é—®é¢˜ä¿®æ­£

**ç¤ºä¾‹**: v1.30.2
- ä¸»ç‰ˆæœ¬å·: 1
- æ¬¡ç‰ˆæœ¬å·: 30  
- ä¿®è®¢å·: 2

### ç‰ˆæœ¬æ”¯æŒç­–ç•¥

Kubernetes ç¤¾åŒºç»´æŠ¤æœ€è¿‘çš„ä¸‰ä¸ªæ¬¡ç‰ˆæœ¬ï¼š

| ç‰ˆæœ¬çŠ¶æ€ | è¯´æ˜ | ç¤ºä¾‹ç‰ˆæœ¬ |
|:---------|:-----|:---------|
| **æœ€æ–°ç‰ˆæœ¬** | æœ€æ–°å‘å¸ƒçš„ç¨³å®šç‰ˆæœ¬ | v1.30.x |
| **ç¨³å®šç‰ˆæœ¬** | å‰ä¸€ä¸ªæ¬¡ç‰ˆæœ¬ | v1.29.x |
| **ç»´æŠ¤ç‰ˆæœ¬** | å‰ä¸¤ä¸ªæ¬¡ç‰ˆæœ¬ | v1.28.x |
| **ä¸æ”¯æŒ** | è¶…è¿‡ä¸‰ä¸ªæ¬¡ç‰ˆæœ¬çš„æ—§ç‰ˆæœ¬ | v1.27.x åŠæ›´æ—© |

## âš ï¸ å‡çº§é™åˆ¶å’Œçº¦æŸ

### ğŸš¨ é‡è¦é™åˆ¶

1. **ä¸èƒ½è·¨æ¬¡ç‰ˆæœ¬å‡çº§**
   - âœ… æ­£ç¡®: v1.28.x â†’ v1.29.x
   - âŒ é”™è¯¯: v1.28.x â†’ v1.30.x

2. **ä¸èƒ½é™çº§**
   - Kubernetes ä¸æ”¯æŒç‰ˆæœ¬é™çº§
   - é™çº§å¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±å’Œé›†ç¾¤ä¸ç¨³å®š

3. **ç»„ä»¶ç‰ˆæœ¬å…¼å®¹æ€§**
   - kubelet ç‰ˆæœ¬ä¸èƒ½é«˜äº kube-apiserver
   - kube-proxy ç‰ˆæœ¬åº”ä¸ kubelet ä¿æŒä¸€è‡´

### ğŸ“‹ å‡çº§å‰æ£€æŸ¥æ¸…å•

- [ ] å¤‡ä»½ etcd æ•°æ®
- [ ] è®°å½•å½“å‰é›†ç¾¤çŠ¶æ€
- [ ] ç¡®è®¤ä¸šåŠ¡åº”ç”¨å…¼å®¹æ€§
- [ ] å‡†å¤‡å›æ»šæ–¹æ¡ˆ
- [ ] é€‰æ‹©åˆé€‚çš„å‡çº§æ—¶é—´çª—å£
- [ ] ç¡®ä¿é›†ç¾¤å¥åº·çŠ¶æ€è‰¯å¥½
- [ ] éªŒè¯ç½‘ç»œè¿æ¥ç¨³å®šæ€§

## ğŸ”§ å‡çº§å‡†å¤‡å·¥ä½œ

### 1. é›†ç¾¤å¥åº·æ£€æŸ¥

```bash
# æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€
kubectl get nodes

# æ£€æŸ¥ç³»ç»Ÿ Pod çŠ¶æ€
kubectl get pods -n kube-system

# æ£€æŸ¥é›†ç¾¤ç»„ä»¶çŠ¶æ€
kubectl get componentstatuses

# æ£€æŸ¥å…³é”®å·¥ä½œè´Ÿè½½
kubectl get pods --all-namespaces | grep -v Running
```

### 2. å¤‡ä»½å…³é”®æ•°æ®

```bash
# æ‰§è¡Œ etcd å¤‡ä»½
ansible-playbook -i example/hosts.m-master.ip.ini 93-backup-cluster.yml

# å¤‡ä»½é‡è¦é…ç½®æ–‡ä»¶
sudo cp -r /etc/kubernetes /etc/kubernetes.backup.$(date +%Y%m%d)
```

### 3. æŸ¥çœ‹å½“å‰ç‰ˆæœ¬ä¿¡æ¯

```bash
# æŸ¥çœ‹é›†ç¾¤ç‰ˆæœ¬
kubectl version

# æŸ¥çœ‹èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯
kubectl get nodes -o wide

# æŸ¥çœ‹ç»„ä»¶ç‰ˆæœ¬
kubeadm version
kubelet --version
```

## ğŸš€ æ‰§è¡Œé›†ç¾¤å‡çº§

### æ–¹æ³•ä¸€ï¼šåŸºæœ¬é…ç½®å‡çº§

é€‚ç”¨äºä½¿ç”¨é»˜è®¤é…ç½®éƒ¨ç½²çš„é›†ç¾¤ï¼š

```bash
# å‡çº§åˆ°æŒ‡å®šç‰ˆæœ¬ï¼ˆè¯·æ›¿æ¢ x ä¸ºå®é™…ç‰ˆæœ¬å·ï¼‰
ansible-playbook -i example/hosts.m-master.ip.ini -e kube_upgrade_version=1.31.x 91-upgrade-cluster.yml
```

### æ–¹æ³•äºŒï¼šé«˜çº§é…ç½®å‡çº§

é€‚ç”¨äºä½¿ç”¨è‡ªå®šä¹‰é…ç½®éƒ¨ç½²çš„é›†ç¾¤ï¼š

1. **ä¿®æ”¹é…ç½®æ–‡ä»¶**

   åœ¨ `example/variables.yaml` æ–‡ä»¶ä¸­æ·»åŠ å‡çº§ç‰ˆæœ¬ï¼š
   ```yaml
   # è®¾ç½®å‡çº§ç›®æ ‡ç‰ˆæœ¬
   kube_upgrade_version: 1.31.2
   ```

2. **æ‰§è¡Œå‡çº§**
   ```bash
   ansible-playbook -i example/hosts.m-master.ip.ini -e @example/variables.yaml 91-upgrade-cluster.yml
   ```

### å‡çº§è¿‡ç¨‹ç›‘æ§

```bash
# ç›‘æ§å‡çº§è¿‡ç¨‹
tail -f /tmp/ansible.log

# åœ¨å¦ä¸€ä¸ªç»ˆç«¯ç›‘æ§é›†ç¾¤çŠ¶æ€
watch kubectl get nodes

# ç›‘æ§ Pod çŠ¶æ€
watch kubectl get pods --all-namespaces
```

## ğŸ”„ å‡çº§æµç¨‹è¯¦è§£

### å‡çº§æ­¥éª¤è¯´æ˜

1. **ğŸ”„ æ§åˆ¶å¹³é¢å‡çº§**
   - å‡çº§ç¬¬ä¸€ä¸ª Master èŠ‚ç‚¹
   - å‡çº§å…¶ä»– Master èŠ‚ç‚¹
   - éªŒè¯æ§åˆ¶å¹³é¢åŠŸèƒ½

2. **ğŸ­ å·¥ä½œèŠ‚ç‚¹å‡çº§**
   - é€ä¸ªå‡çº§ Worker èŠ‚ç‚¹
   - é©±é€å·¥ä½œè´Ÿè½½
   - å‡çº§ kubelet å’Œ kube-proxy

3. **ğŸ” éªŒè¯å’Œæµ‹è¯•**
   - éªŒè¯é›†ç¾¤åŠŸèƒ½
   - æµ‹è¯•å…³é”®åº”ç”¨
   - ç¡®è®¤å‡çº§æˆåŠŸ

### å‡çº§æ—¶é—´ä¼°ç®—

| é›†ç¾¤è§„æ¨¡ | é¢„ä¼°æ—¶é—´ | è¯´æ˜ |
|:---------|:---------|:-----|
| å°å‹é›†ç¾¤ (3-5 èŠ‚ç‚¹) | 30-60 åˆ†é’Ÿ | åŒ…å«éªŒè¯æ—¶é—´ |
| ä¸­å‹é›†ç¾¤ (6-20 èŠ‚ç‚¹) | 1-2 å°æ—¶ | å–å†³äºå·¥ä½œè´Ÿè½½å¤æ‚åº¦ |
| å¤§å‹é›†ç¾¤ (20+ èŠ‚ç‚¹) | 2-4 å°æ—¶ | å¯èƒ½éœ€è¦åˆ†æ‰¹å‡çº§ |

## ğŸ”§ ç‰¹æ®Šæƒ…å†µå¤„ç†

### Docker è¿è¡Œæ—¶å‡çº§

å¯¹äºä» v1.22 åŠæ›´é«˜ç‰ˆæœ¬å‡çº§ä¸”ä½¿ç”¨ Docker ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶çš„é›†ç¾¤ï¼š

> **é‡è¦**: ä» Kubernetes v1.24 å¼€å§‹ï¼ŒDocker æ”¯æŒå·²è¢«ç§»é™¤ï¼Œéœ€è¦å®‰è£… cri-dockerd é€‚é…å™¨ã€‚

```bash
# å…ˆå®‰è£… cri-dockerdï¼ˆå¦‚æœå°šæœªå®‰è£…ï¼‰
ansible-playbook -i example/hosts.m-master.ip.ini [-e @example/variables.yaml] 02-container-engine.yml

# ç„¶åæ‰§è¡Œé›†ç¾¤å‡çº§
ansible-playbook -i example/hosts.m-master.ip.ini -e @example/variables.yaml 91-upgrade-cluster.yml
```

### ç½‘ç»œæ’ä»¶å…¼å®¹æ€§

å‡çº§è¿‡ç¨‹ä¸­å¯èƒ½éœ€è¦æ›´æ–°ç½‘ç»œæ’ä»¶ï¼š

```bash
# å‡çº§ç½‘ç»œæ’ä»¶ï¼ˆå¦‚éœ€è¦ï¼‰
ansible-playbook -i example/hosts.m-master.ip.ini 21-network-plugin.yml
```

## âœ… å‡çº§åéªŒè¯

### 1. åŸºç¡€åŠŸèƒ½éªŒè¯

```bash
# æ£€æŸ¥é›†ç¾¤ç‰ˆæœ¬
kubectl version

# æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€
kubectl get nodes -o wide

# æ£€æŸ¥æ‰€æœ‰ Pod çŠ¶æ€
kubectl get pods --all-namespaces

# æ£€æŸ¥é›†ç¾¤ä¿¡æ¯
kubectl cluster-info
```

### 2. æ·±åº¦åŠŸèƒ½æµ‹è¯•

```bash
# æµ‹è¯• Pod åˆ›å»ºå’Œåˆ é™¤
kubectl run test-pod --image=nginx --rm -it --restart=Never -- echo "Test successful"

# æµ‹è¯•æœåŠ¡å‘ç°
kubectl run test-client --image=busybox --rm -it --restart=Never -- nslookup kubernetes.default

# æµ‹è¯•å­˜å‚¨åŠŸèƒ½ï¼ˆå¦‚æœä½¿ç”¨æŒä¹…å·ï¼‰
kubectl get pv,pvc --all-namespaces

# æµ‹è¯•ç½‘ç»œç­–ç•¥ï¼ˆå¦‚æœå¯ç”¨ï¼‰
kubectl get networkpolicies --all-namespaces
```

### 3. åº”ç”¨å¥åº·æ£€æŸ¥

```bash
# æ£€æŸ¥å…³é”®åº”ç”¨çŠ¶æ€
kubectl get deployments --all-namespaces

# æ£€æŸ¥æœåŠ¡ç«¯ç‚¹
kubectl get endpoints --all-namespaces

# éªŒè¯ Ingress åŠŸèƒ½
kubectl get ingress --all-namespaces
```

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. å‡çº§è¿‡ç¨‹ä¸­æ–­

**ç—‡çŠ¶**: Ansible æ‰§è¡Œå¤±è´¥æˆ–ä¸­æ–­

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥é›†ç¾¤çŠ¶æ€
kubectl get nodes

# é‡æ–°æ‰§è¡Œå‡çº§ï¼ˆæ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼‰
ansible-playbook -i example/hosts.m-master.ip.ini -e kube_upgrade_version=1.31.x 91-upgrade-cluster.yml
```

#### 2. èŠ‚ç‚¹çŠ¶æ€å¼‚å¸¸

**ç—‡çŠ¶**: èŠ‚ç‚¹æ˜¾ç¤º NotReady çŠ¶æ€

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥ kubelet æœåŠ¡
sudo systemctl status kubelet

# é‡å¯ kubelet æœåŠ¡
sudo systemctl restart kubelet

# æŸ¥çœ‹ kubelet æ—¥å¿—
sudo journalctl -u kubelet -f
```

#### 3. Pod æ— æ³•è°ƒåº¦

**ç—‡çŠ¶**: Pod å¤„äº Pending çŠ¶æ€

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥èŠ‚ç‚¹èµ„æº
kubectl describe nodes

# æ£€æŸ¥ Pod äº‹ä»¶
kubectl describe pod <pod-name> -n <namespace>

# æ£€æŸ¥æ±¡ç‚¹å’Œå®¹å¿åº¦
kubectl get nodes -o json | jq '.items[].spec.taints'
```

## ğŸ“‹ å‡çº§åä»»åŠ¡

### 1. æ›´æ–°é…ç½®æ–‡ä»¶

```bash
# æ›´æ–°ä¸»æœºæ¸…å•æ–‡ä»¶ä¸­çš„ç‰ˆæœ¬ä¿¡æ¯
vim example/hosts.m-master.ip.ini

# æ›´æ–° kube_version å€¼ä¸ºå‡çº§åçš„ç‰ˆæœ¬
kube_version="1.31.2"
```

### 2. æ¸…ç†æ—§ç‰ˆæœ¬

```bash
# æ¸…ç†æ—§çš„å®¹å™¨é•œåƒï¼ˆå¯é€‰ï¼‰
ansible -i example/hosts.m-master.ip.ini all -m shell -a "docker system prune -f"

# æˆ–ä½¿ç”¨ crictlï¼ˆcontainerdï¼‰
ansible -i example/hosts.m-master.ip.ini all -m shell -a "crictl rmi --prune"
```

### 3. è®°å½•å‡çº§ä¿¡æ¯

- è®°å½•å‡çº§æ—¶é—´å’Œç‰ˆæœ¬
- è®°å½•å‡çº§è¿‡ç¨‹ä¸­çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ
- æ›´æ–°é›†ç¾¤æ–‡æ¡£å’Œè¿ç»´æ‰‹å†Œ

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ğŸ“‹ å®‰è£…é¡»çŸ¥](00-å®‰è£…é¡»çŸ¥.md) - äº†è§£ç‰ˆæœ¬å…¼å®¹æ€§è¦æ±‚
- [ğŸš€ é›†ç¾¤å®‰è£…](01-é›†ç¾¤å®‰è£….md) - åˆå§‹é›†ç¾¤éƒ¨ç½²
- [ğŸ” è¯ä¹¦è½®æ¢](03-è¯ä¹¦è½®æ¢.md) - å‡çº§æ—¶çš„è¯ä¹¦å¤„ç†
- [ğŸ’¾ é›†ç¾¤å¤‡ä»½](05-é›†ç¾¤å¤‡ä»½.md) - å‡çº§å‰å¤‡ä»½
- [ğŸ”„ é›†ç¾¤æ¢å¤](06-é›†ç¾¤æ¢å¤.md) - å‡çº§å¤±è´¥æ—¶çš„æ¢å¤

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœåœ¨é›†ç¾¤å‡çº§è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š

1. ğŸ“– æŸ¥çœ‹è¯¦ç»†çš„ Ansible æ‰§è¡Œæ—¥å¿—
2. ğŸ” æ£€æŸ¥ Kubernetes å®˜æ–¹å‡çº§æŒ‡å—
3. ğŸ’¾ ç¡®ä¿å·²è¿›è¡Œå……åˆ†çš„å¤‡ä»½
4. ğŸ› [æŠ¥å‘Šé—®é¢˜](https://github.com/TimeBye/Kubernetes/issues) è·å–æŠ€æœ¯æ”¯æŒ

---

**é‡è¦æç¤º**: 
- ğŸš¨ ç”Ÿäº§ç¯å¢ƒå‡çº§å‰åŠ¡å¿…åœ¨æµ‹è¯•ç¯å¢ƒå®Œæ•´éªŒè¯å‡çº§æµç¨‹
- ğŸ“… å»ºè®®åœ¨ä¸šåŠ¡ä½å³°æœŸè¿›è¡Œå‡çº§æ“ä½œ
- ğŸ’¾ å‡çº§å‰åŠ¡å¿…è¿›è¡Œå®Œæ•´å¤‡ä»½
- ğŸ‘¥ å»ºè®®å¤šäººåä½œï¼Œç¡®ä¿å‡çº§è¿‡ç¨‹çš„å®‰å…¨æ€§