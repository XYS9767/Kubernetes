# ⬆️ 集群升级指南

本文档详细介绍如何安全地升级 Kubernetes 集群版本，确保业务连续性和数据安全。

## 📋 升级概述

### 什么是集群升级？

集群升级是指将 Kubernetes 集群从当前版本升级到更高版本的过程，包括升级控制平面组件、工作节点组件以及相关工具。

### 升级的必要性

- **🔒 安全更新**: 获取最新的安全修复和补丁
- **🚀 新功能**: 使用最新的 Kubernetes 特性和功能
- **🛠️ Bug 修复**: 解决已知问题和提升稳定性
- **📈 性能优化**: 获得性能改进和优化
- **🔄 社区支持**: 保持在社区支持的版本范围内

## 📚 版本管理基础

### 语义化版本控制

Kubernetes 使用语义化版本控制，版本格式为：`主版本号.次版本号.修订号`

- **主版本号**: 不兼容的 API 修改
- **次版本号**: 向下兼容的功能性新增
- **修订号**: 向下兼容的问题修正

**示例**: v1.30.2
- 主版本号: 1
- 次版本号: 30  
- 修订号: 2

### 版本支持策略

Kubernetes 社区维护最近的三个次版本：

| 版本状态 | 说明 | 示例版本 |
|:---------|:-----|:---------|
| **最新版本** | 最新发布的稳定版本 | v1.30.x |
| **稳定版本** | 前一个次版本 | v1.29.x |
| **维护版本** | 前两个次版本 | v1.28.x |
| **不支持** | 超过三个次版本的旧版本 | v1.27.x 及更早 |

## ⚠️ 升级限制和约束

### 🚨 重要限制

1. **不能跨次版本升级**
   - ✅ 正确: v1.28.x → v1.29.x
   - ❌ 错误: v1.28.x → v1.30.x

2. **不能降级**
   - Kubernetes 不支持版本降级
   - 降级可能导致数据丢失和集群不稳定

3. **组件版本兼容性**
   - kubelet 版本不能高于 kube-apiserver
   - kube-proxy 版本应与 kubelet 保持一致

### 📋 升级前检查清单

- [ ] 备份 etcd 数据
- [ ] 记录当前集群状态
- [ ] 确认业务应用兼容性
- [ ] 准备回滚方案
- [ ] 选择合适的升级时间窗口
- [ ] 确保集群健康状态良好
- [ ] 验证网络连接稳定性

## 🔧 升级准备工作

### 1. 集群健康检查

```bash
# 检查节点状态
kubectl get nodes

# 检查系统 Pod 状态
kubectl get pods -n kube-system

# 检查集群组件状态
kubectl get componentstatuses

# 检查关键工作负载
kubectl get pods --all-namespaces | grep -v Running
```

### 2. 备份关键数据

```bash
# 执行 etcd 备份
ansible-playbook -i example/hosts.m-master.ip.ini 93-backup-cluster.yml

# 备份重要配置文件
sudo cp -r /etc/kubernetes /etc/kubernetes.backup.$(date +%Y%m%d)
```

### 3. 查看当前版本信息

```bash
# 查看集群版本
kubectl version

# 查看节点详细信息
kubectl get nodes -o wide

# 查看组件版本
kubeadm version
kubelet --version
```

## 🚀 执行集群升级

### 方法一：基本配置升级

适用于使用默认配置部署的集群：

```bash
# 升级到指定版本（请替换 x 为实际版本号）
ansible-playbook -i example/hosts.m-master.ip.ini -e kube_upgrade_version=1.31.x 91-upgrade-cluster.yml
```

### 方法二：高级配置升级

适用于使用自定义配置部署的集群：

1. **修改配置文件**

   在 `example/variables.yaml` 文件中添加升级版本：
   ```yaml
   # 设置升级目标版本
   kube_upgrade_version: 1.31.2
   ```

2. **执行升级**
   ```bash
   ansible-playbook -i example/hosts.m-master.ip.ini -e @example/variables.yaml 91-upgrade-cluster.yml
   ```

### 升级过程监控

```bash
# 监控升级过程
tail -f /tmp/ansible.log

# 在另一个终端监控集群状态
watch kubectl get nodes

# 监控 Pod 状态
watch kubectl get pods --all-namespaces
```

## 🔄 升级流程详解

### 升级步骤说明

1. **🔄 控制平面升级**
   - 升级第一个 Master 节点
   - 升级其他 Master 节点
   - 验证控制平面功能

2. **🏭 工作节点升级**
   - 逐个升级 Worker 节点
   - 驱逐工作负载
   - 升级 kubelet 和 kube-proxy

3. **🔍 验证和测试**
   - 验证集群功能
   - 测试关键应用
   - 确认升级成功

### 升级时间估算

| 集群规模 | 预估时间 | 说明 |
|:---------|:---------|:-----|
| 小型集群 (3-5 节点) | 30-60 分钟 | 包含验证时间 |
| 中型集群 (6-20 节点) | 1-2 小时 | 取决于工作负载复杂度 |
| 大型集群 (20+ 节点) | 2-4 小时 | 可能需要分批升级 |

## 🔧 特殊情况处理

### Docker 运行时升级

对于从 v1.22 及更高版本升级且使用 Docker 作为容器运行时的集群：

> **重要**: 从 Kubernetes v1.24 开始，Docker 支持已被移除，需要安装 cri-dockerd 适配器。

```bash
# 先安装 cri-dockerd（如果尚未安装）
ansible-playbook -i example/hosts.m-master.ip.ini [-e @example/variables.yaml] 02-container-engine.yml

# 然后执行集群升级
ansible-playbook -i example/hosts.m-master.ip.ini -e @example/variables.yaml 91-upgrade-cluster.yml
```

### 网络插件兼容性

升级过程中可能需要更新网络插件：

```bash
# 升级网络插件（如需要）
ansible-playbook -i example/hosts.m-master.ip.ini 21-network-plugin.yml
```

## ✅ 升级后验证

### 1. 基础功能验证

```bash
# 检查集群版本
kubectl version

# 检查节点状态
kubectl get nodes -o wide

# 检查所有 Pod 状态
kubectl get pods --all-namespaces

# 检查集群信息
kubectl cluster-info
```

### 2. 深度功能测试

```bash
# 测试 Pod 创建和删除
kubectl run test-pod --image=nginx --rm -it --restart=Never -- echo "Test successful"

# 测试服务发现
kubectl run test-client --image=busybox --rm -it --restart=Never -- nslookup kubernetes.default

# 测试存储功能（如果使用持久卷）
kubectl get pv,pvc --all-namespaces

# 测试网络策略（如果启用）
kubectl get networkpolicies --all-namespaces
```

### 3. 应用健康检查

```bash
# 检查关键应用状态
kubectl get deployments --all-namespaces

# 检查服务端点
kubectl get endpoints --all-namespaces

# 验证 Ingress 功能
kubectl get ingress --all-namespaces
```

## 🛠️ 故障排查

### 常见问题及解决方案

#### 1. 升级过程中断

**症状**: Ansible 执行失败或中断

**解决方案**:
```bash
# 检查集群状态
kubectl get nodes

# 重新执行升级（支持断点续传）
ansible-playbook -i example/hosts.m-master.ip.ini -e kube_upgrade_version=1.31.x 91-upgrade-cluster.yml
```

#### 2. 节点状态异常

**症状**: 节点显示 NotReady 状态

**解决方案**:
```bash
# 检查 kubelet 服务
sudo systemctl status kubelet

# 重启 kubelet 服务
sudo systemctl restart kubelet

# 查看 kubelet 日志
sudo journalctl -u kubelet -f
```

#### 3. Pod 无法调度

**症状**: Pod 处于 Pending 状态

**解决方案**:
```bash
# 检查节点资源
kubectl describe nodes

# 检查 Pod 事件
kubectl describe pod <pod-name> -n <namespace>

# 检查污点和容忍度
kubectl get nodes -o json | jq '.items[].spec.taints'
```

## 📋 升级后任务

### 1. 更新配置文件

```bash
# 更新主机清单文件中的版本信息
vim example/hosts.m-master.ip.ini

# 更新 kube_version 值为升级后的版本
kube_version="1.31.2"
```

### 2. 清理旧版本

```bash
# 清理旧的容器镜像（可选）
ansible -i example/hosts.m-master.ip.ini all -m shell -a "docker system prune -f"

# 或使用 crictl（containerd）
ansible -i example/hosts.m-master.ip.ini all -m shell -a "crictl rmi --prune"
```

### 3. 记录升级信息

- 记录升级时间和版本
- 记录升级过程中的问题和解决方案
- 更新集群文档和运维手册

## 📚 相关文档

- [📋 安装须知](00-安装须知.md) - 了解版本兼容性要求
- [🚀 集群安装](01-集群安装.md) - 初始集群部署
- [🔐 证书轮换](03-证书轮换.md) - 升级时的证书处理
- [💾 集群备份](05-集群备份.md) - 升级前备份
- [🔄 集群恢复](06-集群恢复.md) - 升级失败时的恢复

## 📞 获取帮助

如果在集群升级过程中遇到问题：

1. 📖 查看详细的 Ansible 执行日志
2. 🔍 检查 Kubernetes 官方升级指南
3. 💾 确保已进行充分的备份
4. 🐛 [报告问题](https://github.com/TimeBye/Kubernetes/issues) 获取技术支持

---

**重要提示**: 
- 🚨 生产环境升级前务必在测试环境完整验证升级流程
- 📅 建议在业务低峰期进行升级操作
- 💾 升级前务必进行完整备份
- 👥 建议多人协作，确保升级过程的安全性