# 🔐 证书轮换指南

本文档介绍如何在 Kubernetes 集群中进行证书的轮换和更新操作，确保集群安全性和持续运行。

## 📋 概述

### 什么是证书轮换？

证书轮换是指在现有证书到期之前，生成新的证书并替换旧证书的过程。这是维护 Kubernetes 集群安全性的重要操作。

### 为什么需要证书轮换？

- **🔒 安全性**: 定期更换证书可以降低密钥泄露的风险
- **⏰ 避免过期**: 防止证书过期导致集群组件无法正常通信
- **📋 合规要求**: 满足企业或行业的安全合规标准
- **🔄 灾难恢复**: 作为集群维护和灾难恢复流程的一部分

## ⚙️ 证书配置说明

### 默认证书设置

本项目中的证书配置采用以下默认设置：

| 证书类型 | 默认有效期 | 说明 |
|:---------|:-----------|:-----|
| **Kubernetes CA 根证书** | 100 年 | 集群的根证书颁发机构 |
| **Kubernetes 组件证书** | 10 年 | 由 CA 根证书签发的组件证书 |
| **Etcd CA 根证书** | 100 年 | Etcd 集群的根证书颁发机构 |
| **Etcd 组件证书** | 10 年 | 由 Etcd CA 签发的组件证书 |

### 自定义证书有效期

如需自定义证书有效期，可在 `example/variables.yaml` 文件中进行配置：

```yaml
# Kubernetes 证书配置
kube_ca_certs_expired: 36500        # CA 根证书有效期（天）
kube_certs_expired: 3650             # 组件证书有效期（天）

# Etcd 证书配置  
etcd_ca_certs_expired: 36500         # Etcd CA 根证书有效期（天）
etcd_certs_expired: 3650              # Etcd 组件证书有效期（天）
```

## 🔍 证书状态检查

### 检查证书有效期

在执行证书轮换之前，建议先检查当前证书的状态：

```bash
# 检查 Kubernetes 证书状态
kubeadm certs check-expiration

# 检查 Etcd 证书状态（在 Master 节点执行）
sudo openssl x509 -in /etc/kubernetes/pki/etcd/server.crt -noout -text | grep -A 2 "Validity"

# 检查 API Server 证书
sudo openssl x509 -in /etc/kubernetes/pki/apiserver.crt -noout -text | grep -A 2 "Validity"
```

### 证书状态输出示例

```
CERTIFICATE                EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED
admin.conf                 Dec 30, 2034 14:05 UTC   9y              ca                      no      
apiserver                  Dec 30, 2034 14:05 UTC   9y              ca                      no      
apiserver-etcd-client      Dec 30, 2034 14:05 UTC   9y              etcd-ca                 no      
apiserver-kubelet-client   Dec 30, 2034 14:05 UTC   9y              ca                      no      
controller-manager.conf    Dec 30, 2034 14:05 UTC   9y              ca                      no      
etcd-healthcheck-client    Dec 30, 2034 14:05 UTC   9y              etcd-ca                 no      
etcd-peer                  Dec 30, 2034 14:05 UTC   9y              etcd-ca                 no      
etcd-server                Dec 30, 2034 14:05 UTC   9y              etcd-ca                 no      
front-proxy-client         Dec 30, 2034 14:05 UTC   9y              front-proxy-ca          no      
scheduler.conf             Dec 30, 2034 14:05 UTC   9y              ca                      no 
```

## 🔄 执行证书轮换

### 方法一：基本配置轮换

适用于使用默认配置部署的集群：

```bash
# 执行证书轮换
ansible-playbook -i example/hosts.m-master.ip.ini 92-certificates-renew.yml
```

### 方法二：高级配置轮换

适用于使用自定义配置部署的集群：

```bash
# 使用自定义配置进行证书轮换
ansible-playbook -i example/hosts.m-master.ip.ini -e @example/variables.yaml 92-certificates-renew.yml
```

> **重要提醒**: 如果集群是使用高级配置（`-e @example/variables.yaml`）部署的，那么证书轮换也必须使用相同的配置参数。

## 🔧 轮换过程详解

### 轮换流程步骤

证书轮换过程包含以下主要步骤：

1. **📋 备份现有证书**
   - 自动备份当前有效的证书文件
   - 创建带时间戳的备份目录

2. **🔑 生成新证书**
   - 使用相同的 CA 根证书生成新的组件证书
   - 保持证书配置和扩展属性一致

3. **📁 分发新证书**
   - 将新证书分发到相应的节点
   - 更新证书文件权限和属主

4. **🔄 重启相关服务**
   - 重启 kubelet 服务应用新证书
   - 重启容器运行时服务（如需要）

### 监控轮换过程

```bash
# 监控 Ansible 执行过程
tail -f /tmp/ansible.log

# 在另一个终端监控集群状态
watch kubectl get nodes

# 监控 Pod 状态
watch kubectl get pods --all-namespaces
```

## ⚠️ 注意事项

### 🚨 重要提醒

1. **服务重启要求**
   - 证书轮换后必须手动重启相关服务
   - 建议在业务低峰期进行操作

2. **备份重要性**
   - 操作前建议额外手动备份证书
   - 确保有回滚方案

3. **网络稳定性**
   - 确保 Ansible 控制节点与所有目标节点网络稳定
   - 避免在网络不稳定时进行证书轮换

4. **时间同步**
   - 确保所有节点时间同步
   - 时间偏差可能导致证书验证失败

### 🔧 后续操作

证书轮换完成后，需要执行以下操作：

```bash
# 重启 Docker 服务（如使用 Docker 运行时）
sudo systemctl restart docker

# 重启 containerd 服务（如使用 containerd 运行时）
sudo systemctl restart containerd

# 重启 kubelet 服务
sudo systemctl restart kubelet

# 验证服务状态
sudo systemctl status kubelet
sudo systemctl status containerd  # 或 docker
```

## ✅ 验证轮换结果

### 验证步骤

1. **检查证书有效期**
   ```bash
   # 再次检查证书状态
   kubeadm certs check-expiration
   ```

2. **验证集群功能**
   ```bash
   # 检查节点状态
   kubectl get nodes
   
   # 检查系统 Pod 状态
   kubectl get pods -n kube-system
   
   # 检查集群信息
   kubectl cluster-info
   ```

3. **测试 API 访问**
   ```bash
   # 测试 kubectl 命令
   kubectl get namespaces
   
   # 测试 API Server 连接
   kubectl version
   ```

4. **检查 Etcd 集群**
   ```bash
   # 检查 Etcd 健康状态
   kubectl -n kube-system exec -it etcd-<node-name> -- etcdctl \
     --endpoints=https://127.0.0.1:2379 \
     --cacert=/etc/kubernetes/pki/etcd/ca.crt \
     --cert=/etc/kubernetes/pki/etcd/server.crt \
     --key=/etc/kubernetes/pki/etcd/server.key \
     endpoint health
   ```

## 🛠️ 故障排查

### 常见问题及解决方案

#### 1. 证书轮换失败

**症状**: Ansible 执行过程中报错

**解决方案**:
```bash
# 检查网络连接
ansible -i example/hosts.m-master.ip.ini all -m ping

# 检查磁盘空间
ansible -i example/hosts.m-master.ip.ini all -m command -a "df -h"

# 检查时间同步
ansible -i example/hosts.m-master.ip.ini all -m command -a "date"
```

#### 2. 服务无法启动

**症状**: kubelet 或其他服务启动失败

**解决方案**:
```bash
# 检查服务状态
sudo systemctl status kubelet

# 查看服务日志
sudo journalctl -u kubelet -f

# 检查证书权限
sudo ls -la /etc/kubernetes/pki/
```

#### 3. API Server 无法访问

**症状**: kubectl 命令执行失败

**解决方案**:
```bash
# 检查 API Server Pod 状态
sudo docker ps | grep apiserver  # 或使用 crictl

# 检查 API Server 日志
sudo journalctl -u kubelet | grep apiserver

# 验证证书配置
sudo openssl verify -CAfile /etc/kubernetes/pki/ca.crt /etc/kubernetes/pki/apiserver.crt
```

## 📚 相关文档

- [📋 安装须知](00-安装须知.md) - 了解证书相关要求
- [🚀 集群安装](01-集群安装.md) - 初始证书配置
- [⬆️ 集群升级](04-集群升级.md) - 升级时的证书处理
- [💾 集群备份](05-集群备份.md) - 包含证书备份
- [🔄 集群恢复](06-集群恢复.md) - 证书恢复流程

## 📞 获取帮助

如果在证书轮换过程中遇到问题：

1. 📖 查看详细的错误日志
2. 🔍 检查证书文件和权限
3. ⏰ 确认时间同步状态
4. 🐛 [报告问题](https://github.com/TimeBye/Kubernetes/issues) 获取技术支持

---

**提示**: 建议定期（如每年）进行证书轮换，确保集群的长期安全运行。在生产环境执行前，务必在测试环境验证整个流程。