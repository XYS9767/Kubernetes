# ğŸ” è¯ä¹¦è½®æ¢æŒ‡å—

æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•åœ¨ Kubernetes é›†ç¾¤ä¸­è¿›è¡Œè¯ä¹¦çš„è½®æ¢å’Œæ›´æ–°æ“ä½œï¼Œç¡®ä¿é›†ç¾¤å®‰å…¨æ€§å’ŒæŒç»­è¿è¡Œã€‚

## ğŸ“‹ æ¦‚è¿°

### ä»€ä¹ˆæ˜¯è¯ä¹¦è½®æ¢ï¼Ÿ

è¯ä¹¦è½®æ¢æ˜¯æŒ‡åœ¨ç°æœ‰è¯ä¹¦åˆ°æœŸä¹‹å‰ï¼Œç”Ÿæˆæ–°çš„è¯ä¹¦å¹¶æ›¿æ¢æ—§è¯ä¹¦çš„è¿‡ç¨‹ã€‚è¿™æ˜¯ç»´æŠ¤ Kubernetes é›†ç¾¤å®‰å…¨æ€§çš„é‡è¦æ“ä½œã€‚

### ä¸ºä»€ä¹ˆéœ€è¦è¯ä¹¦è½®æ¢ï¼Ÿ

- **ğŸ”’ å®‰å…¨æ€§**: å®šæœŸæ›´æ¢è¯ä¹¦å¯ä»¥é™ä½å¯†é’¥æ³„éœ²çš„é£é™©
- **â° é¿å…è¿‡æœŸ**: é˜²æ­¢è¯ä¹¦è¿‡æœŸå¯¼è‡´é›†ç¾¤ç»„ä»¶æ— æ³•æ­£å¸¸é€šä¿¡
- **ğŸ“‹ åˆè§„è¦æ±‚**: æ»¡è¶³ä¼ä¸šæˆ–è¡Œä¸šçš„å®‰å…¨åˆè§„æ ‡å‡†
- **ğŸ”„ ç¾éš¾æ¢å¤**: ä½œä¸ºé›†ç¾¤ç»´æŠ¤å’Œç¾éš¾æ¢å¤æµç¨‹çš„ä¸€éƒ¨åˆ†

## âš™ï¸ è¯ä¹¦é…ç½®è¯´æ˜

### é»˜è®¤è¯ä¹¦è®¾ç½®

æœ¬é¡¹ç›®ä¸­çš„è¯ä¹¦é…ç½®é‡‡ç”¨ä»¥ä¸‹é»˜è®¤è®¾ç½®ï¼š

| è¯ä¹¦ç±»å‹ | é»˜è®¤æœ‰æ•ˆæœŸ | è¯´æ˜ |
|:---------|:-----------|:-----|
| **Kubernetes CA æ ¹è¯ä¹¦** | 100 å¹´ | é›†ç¾¤çš„æ ¹è¯ä¹¦é¢å‘æœºæ„ |
| **Kubernetes ç»„ä»¶è¯ä¹¦** | 10 å¹´ | ç”± CA æ ¹è¯ä¹¦ç­¾å‘çš„ç»„ä»¶è¯ä¹¦ |
| **Etcd CA æ ¹è¯ä¹¦** | 100 å¹´ | Etcd é›†ç¾¤çš„æ ¹è¯ä¹¦é¢å‘æœºæ„ |
| **Etcd ç»„ä»¶è¯ä¹¦** | 10 å¹´ | ç”± Etcd CA ç­¾å‘çš„ç»„ä»¶è¯ä¹¦ |

### è‡ªå®šä¹‰è¯ä¹¦æœ‰æ•ˆæœŸ

å¦‚éœ€è‡ªå®šä¹‰è¯ä¹¦æœ‰æ•ˆæœŸï¼Œå¯åœ¨ `example/variables.yaml` æ–‡ä»¶ä¸­è¿›è¡Œé…ç½®ï¼š

```yaml
# Kubernetes è¯ä¹¦é…ç½®
kube_ca_certs_expired: 36500        # CA æ ¹è¯ä¹¦æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰
kube_certs_expired: 3650             # ç»„ä»¶è¯ä¹¦æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰

# Etcd è¯ä¹¦é…ç½®  
etcd_ca_certs_expired: 36500         # Etcd CA æ ¹è¯ä¹¦æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰
etcd_certs_expired: 3650              # Etcd ç»„ä»¶è¯ä¹¦æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰
```

## ğŸ” è¯ä¹¦çŠ¶æ€æ£€æŸ¥

### æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸ

åœ¨æ‰§è¡Œè¯ä¹¦è½®æ¢ä¹‹å‰ï¼Œå»ºè®®å…ˆæ£€æŸ¥å½“å‰è¯ä¹¦çš„çŠ¶æ€ï¼š

```bash
# æ£€æŸ¥ Kubernetes è¯ä¹¦çŠ¶æ€
kubeadm certs check-expiration

# æ£€æŸ¥ Etcd è¯ä¹¦çŠ¶æ€ï¼ˆåœ¨ Master èŠ‚ç‚¹æ‰§è¡Œï¼‰
sudo openssl x509 -in /etc/kubernetes/pki/etcd/server.crt -noout -text | grep -A 2 "Validity"

# æ£€æŸ¥ API Server è¯ä¹¦
sudo openssl x509 -in /etc/kubernetes/pki/apiserver.crt -noout -text | grep -A 2 "Validity"
```

### è¯ä¹¦çŠ¶æ€è¾“å‡ºç¤ºä¾‹

```
CERTIFICATE                EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED
admin.conf                 Dec 30, 2034 14:05 UTC   9y              ca                      no      
apiserver                  Dec 30, 2034 14:05 UTC   9y              ca                      no      
apiserver-etcd-client      Dec 30, 2034 14:05 UTC   9y              etcd-ca                 no      
apiserver-kubelet-client   Dec 30, 2034 14:05 UTC   9y              ca                      no      
controller-manager.conf    Dec 30, 2034 14:05 UTC   9y              ca                      no      
etcd-healthcheck-client    Dec 30, 2034 14:05 UTC   9y              etcd-ca                 no      
etcd-peer                  Dec 30, 2034 14:05 UTC   9y              etcd-ca                 no      
etcd-server                Dec 30, 2034 14:05 UTC   9y              etcd-ca                 no      
front-proxy-client         Dec 30, 2034 14:05 UTC   9y              front-proxy-ca          no      
scheduler.conf             Dec 30, 2034 14:05 UTC   9y              ca                      no 
```

## ğŸ”„ æ‰§è¡Œè¯ä¹¦è½®æ¢

### æ–¹æ³•ä¸€ï¼šåŸºæœ¬é…ç½®è½®æ¢

é€‚ç”¨äºä½¿ç”¨é»˜è®¤é…ç½®éƒ¨ç½²çš„é›†ç¾¤ï¼š

```bash
# æ‰§è¡Œè¯ä¹¦è½®æ¢
ansible-playbook -i example/hosts.m-master.ip.ini 92-certificates-renew.yml
```

### æ–¹æ³•äºŒï¼šé«˜çº§é…ç½®è½®æ¢

é€‚ç”¨äºä½¿ç”¨è‡ªå®šä¹‰é…ç½®éƒ¨ç½²çš„é›†ç¾¤ï¼š

```bash
# ä½¿ç”¨è‡ªå®šä¹‰é…ç½®è¿›è¡Œè¯ä¹¦è½®æ¢
ansible-playbook -i example/hosts.m-master.ip.ini -e @example/variables.yaml 92-certificates-renew.yml
```

> **é‡è¦æé†’**: å¦‚æœé›†ç¾¤æ˜¯ä½¿ç”¨é«˜çº§é…ç½®ï¼ˆ`-e @example/variables.yaml`ï¼‰éƒ¨ç½²çš„ï¼Œé‚£ä¹ˆè¯ä¹¦è½®æ¢ä¹Ÿå¿…é¡»ä½¿ç”¨ç›¸åŒçš„é…ç½®å‚æ•°ã€‚

## ğŸ”§ è½®æ¢è¿‡ç¨‹è¯¦è§£

### è½®æ¢æµç¨‹æ­¥éª¤

è¯ä¹¦è½®æ¢è¿‡ç¨‹åŒ…å«ä»¥ä¸‹ä¸»è¦æ­¥éª¤ï¼š

1. **ğŸ“‹ å¤‡ä»½ç°æœ‰è¯ä¹¦**
   - è‡ªåŠ¨å¤‡ä»½å½“å‰æœ‰æ•ˆçš„è¯ä¹¦æ–‡ä»¶
   - åˆ›å»ºå¸¦æ—¶é—´æˆ³çš„å¤‡ä»½ç›®å½•

2. **ğŸ”‘ ç”Ÿæˆæ–°è¯ä¹¦**
   - ä½¿ç”¨ç›¸åŒçš„ CA æ ¹è¯ä¹¦ç”Ÿæˆæ–°çš„ç»„ä»¶è¯ä¹¦
   - ä¿æŒè¯ä¹¦é…ç½®å’Œæ‰©å±•å±æ€§ä¸€è‡´

3. **ğŸ“ åˆ†å‘æ–°è¯ä¹¦**
   - å°†æ–°è¯ä¹¦åˆ†å‘åˆ°ç›¸åº”çš„èŠ‚ç‚¹
   - æ›´æ–°è¯ä¹¦æ–‡ä»¶æƒé™å’Œå±ä¸»

4. **ğŸ”„ é‡å¯ç›¸å…³æœåŠ¡**
   - é‡å¯ kubelet æœåŠ¡åº”ç”¨æ–°è¯ä¹¦
   - é‡å¯å®¹å™¨è¿è¡Œæ—¶æœåŠ¡ï¼ˆå¦‚éœ€è¦ï¼‰

### ç›‘æ§è½®æ¢è¿‡ç¨‹

```bash
# ç›‘æ§ Ansible æ‰§è¡Œè¿‡ç¨‹
tail -f /tmp/ansible.log

# åœ¨å¦ä¸€ä¸ªç»ˆç«¯ç›‘æ§é›†ç¾¤çŠ¶æ€
watch kubectl get nodes

# ç›‘æ§ Pod çŠ¶æ€
watch kubectl get pods --all-namespaces
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### ğŸš¨ é‡è¦æé†’

1. **æœåŠ¡é‡å¯è¦æ±‚**
   - è¯ä¹¦è½®æ¢åå¿…é¡»æ‰‹åŠ¨é‡å¯ç›¸å…³æœåŠ¡
   - å»ºè®®åœ¨ä¸šåŠ¡ä½å³°æœŸè¿›è¡Œæ“ä½œ

2. **å¤‡ä»½é‡è¦æ€§**
   - æ“ä½œå‰å»ºè®®é¢å¤–æ‰‹åŠ¨å¤‡ä»½è¯ä¹¦
   - ç¡®ä¿æœ‰å›æ»šæ–¹æ¡ˆ

3. **ç½‘ç»œç¨³å®šæ€§**
   - ç¡®ä¿ Ansible æ§åˆ¶èŠ‚ç‚¹ä¸æ‰€æœ‰ç›®æ ‡èŠ‚ç‚¹ç½‘ç»œç¨³å®š
   - é¿å…åœ¨ç½‘ç»œä¸ç¨³å®šæ—¶è¿›è¡Œè¯ä¹¦è½®æ¢

4. **æ—¶é—´åŒæ­¥**
   - ç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹æ—¶é—´åŒæ­¥
   - æ—¶é—´åå·®å¯èƒ½å¯¼è‡´è¯ä¹¦éªŒè¯å¤±è´¥

### ğŸ”§ åç»­æ“ä½œ

è¯ä¹¦è½®æ¢å®Œæˆåï¼Œéœ€è¦æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

```bash
# é‡å¯ Docker æœåŠ¡ï¼ˆå¦‚ä½¿ç”¨ Docker è¿è¡Œæ—¶ï¼‰
sudo systemctl restart docker

# é‡å¯ containerd æœåŠ¡ï¼ˆå¦‚ä½¿ç”¨ containerd è¿è¡Œæ—¶ï¼‰
sudo systemctl restart containerd

# é‡å¯ kubelet æœåŠ¡
sudo systemctl restart kubelet

# éªŒè¯æœåŠ¡çŠ¶æ€
sudo systemctl status kubelet
sudo systemctl status containerd  # æˆ– docker
```

## âœ… éªŒè¯è½®æ¢ç»“æœ

### éªŒè¯æ­¥éª¤

1. **æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸ**
   ```bash
   # å†æ¬¡æ£€æŸ¥è¯ä¹¦çŠ¶æ€
   kubeadm certs check-expiration
   ```

2. **éªŒè¯é›†ç¾¤åŠŸèƒ½**
   ```bash
   # æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€
   kubectl get nodes
   
   # æ£€æŸ¥ç³»ç»Ÿ Pod çŠ¶æ€
   kubectl get pods -n kube-system
   
   # æ£€æŸ¥é›†ç¾¤ä¿¡æ¯
   kubectl cluster-info
   ```

3. **æµ‹è¯• API è®¿é—®**
   ```bash
   # æµ‹è¯• kubectl å‘½ä»¤
   kubectl get namespaces
   
   # æµ‹è¯• API Server è¿æ¥
   kubectl version
   ```

4. **æ£€æŸ¥ Etcd é›†ç¾¤**
   ```bash
   # æ£€æŸ¥ Etcd å¥åº·çŠ¶æ€
   kubectl -n kube-system exec -it etcd-<node-name> -- etcdctl \
     --endpoints=https://127.0.0.1:2379 \
     --cacert=/etc/kubernetes/pki/etcd/ca.crt \
     --cert=/etc/kubernetes/pki/etcd/server.crt \
     --key=/etc/kubernetes/pki/etcd/server.key \
     endpoint health
   ```

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. è¯ä¹¦è½®æ¢å¤±è´¥

**ç—‡çŠ¶**: Ansible æ‰§è¡Œè¿‡ç¨‹ä¸­æŠ¥é”™

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥ç½‘ç»œè¿æ¥
ansible -i example/hosts.m-master.ip.ini all -m ping

# æ£€æŸ¥ç£ç›˜ç©ºé—´
ansible -i example/hosts.m-master.ip.ini all -m command -a "df -h"

# æ£€æŸ¥æ—¶é—´åŒæ­¥
ansible -i example/hosts.m-master.ip.ini all -m command -a "date"
```

#### 2. æœåŠ¡æ— æ³•å¯åŠ¨

**ç—‡çŠ¶**: kubelet æˆ–å…¶ä»–æœåŠ¡å¯åŠ¨å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status kubelet

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
sudo journalctl -u kubelet -f

# æ£€æŸ¥è¯ä¹¦æƒé™
sudo ls -la /etc/kubernetes/pki/
```

#### 3. API Server æ— æ³•è®¿é—®

**ç—‡çŠ¶**: kubectl å‘½ä»¤æ‰§è¡Œå¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥ API Server Pod çŠ¶æ€
sudo docker ps | grep apiserver  # æˆ–ä½¿ç”¨ crictl

# æ£€æŸ¥ API Server æ—¥å¿—
sudo journalctl -u kubelet | grep apiserver

# éªŒè¯è¯ä¹¦é…ç½®
sudo openssl verify -CAfile /etc/kubernetes/pki/ca.crt /etc/kubernetes/pki/apiserver.crt
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ğŸ“‹ å®‰è£…é¡»çŸ¥](00-å®‰è£…é¡»çŸ¥.md) - äº†è§£è¯ä¹¦ç›¸å…³è¦æ±‚
- [ğŸš€ é›†ç¾¤å®‰è£…](01-é›†ç¾¤å®‰è£….md) - åˆå§‹è¯ä¹¦é…ç½®
- [â¬†ï¸ é›†ç¾¤å‡çº§](04-é›†ç¾¤å‡çº§.md) - å‡çº§æ—¶çš„è¯ä¹¦å¤„ç†
- [ğŸ’¾ é›†ç¾¤å¤‡ä»½](05-é›†ç¾¤å¤‡ä»½.md) - åŒ…å«è¯ä¹¦å¤‡ä»½
- [ğŸ”„ é›†ç¾¤æ¢å¤](06-é›†ç¾¤æ¢å¤.md) - è¯ä¹¦æ¢å¤æµç¨‹

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœåœ¨è¯ä¹¦è½®æ¢è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š

1. ğŸ“– æŸ¥çœ‹è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
2. ğŸ” æ£€æŸ¥è¯ä¹¦æ–‡ä»¶å’Œæƒé™
3. â° ç¡®è®¤æ—¶é—´åŒæ­¥çŠ¶æ€
4. ğŸ› [æŠ¥å‘Šé—®é¢˜](https://github.com/TimeBye/Kubernetes/issues) è·å–æŠ€æœ¯æ”¯æŒ

---

**æç¤º**: å»ºè®®å®šæœŸï¼ˆå¦‚æ¯å¹´ï¼‰è¿›è¡Œè¯ä¹¦è½®æ¢ï¼Œç¡®ä¿é›†ç¾¤çš„é•¿æœŸå®‰å…¨è¿è¡Œã€‚åœ¨ç”Ÿäº§ç¯å¢ƒæ‰§è¡Œå‰ï¼ŒåŠ¡å¿…åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯æ•´ä¸ªæµç¨‹ã€‚